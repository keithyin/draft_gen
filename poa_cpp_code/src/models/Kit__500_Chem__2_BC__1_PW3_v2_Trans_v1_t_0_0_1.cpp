// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"
#include <eigen3/Eigen/Dense>

using namespace Eigen;

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model(const NucleotideLevelFeats& feats);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor : public Recursor<Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor>
{
public:
    Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
 {0.40850458,0.005932123,0.003091499,0.0034081703,0.36208883,0.003727032,0.0013918821,0.0018255584,0.20568502,0.0028439092,0.0005675465,0.00084041216,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333,0.0000017960333},
{0.008918457,0.29801625,0.0028142014,0.0018245231,0.008152356,0.37477398,0.0021532057,0.001118639,0.007204397,0.29267845,0.0014236962,0.0007990608,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507,0.0000023625507},
{0.01262389,0.0037607152,0.5400551,0.0056822468,0.011332509,0.002380473,0.3160969,0.0022455698,0.00915007,0.0029565198,0.092056885,0.0015216585,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952,0.0000026438952},
{0.009880819,0.0026160285,0.012579987,0.45450422,0.009172791,0.0019732506,0.0069323312,0.34718183,0.009053776,0.0031509842,0.0030259085,0.13982387,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454,0.0000020039454},
{0.31446183,0.006140952,0.0024205053,0.0020613775,0.34236392,0.006739157,0.0010916679,0.0009955345,0.3131463,0.0093145175,0.00059639005,0.0005686575,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781,0.0000019077781},
{0.0054909424,0.20536593,0.004272911,0.002287695,0.0041264202,0.30271602,0.0030734877,0.0016179681,0.0032485807,0.46377218,0.0025115998,0.0013985358,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962,0.0000022638962},
{0.004386607,0.0068204137,0.40902174,0.0035696537,0.0019812658,0.0074063377,0.3468889,0.0020740654,0.0014707361,0.009631103,0.20519763,0.0014576049,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387,0.0000018066387},
{0.0017108256,0.0039509158,0.008581587,0.3103579,0.0011324236,0.004534847,0.0064212354,0.3365243,0.0012708505,0.0068539213,0.0045519383,0.3139753,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606,0.0000025762606},
{0.33049476,0.004168441,0.0064753788,0.002495983,0.34098804,0.002735845,0.004854918,0.0013587879,0.29891428,0.003128776,0.0034738134,0.0007910898,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453,0.0000023047453},
{0.0026162637,0.20032185,0.0050467798,0.0021142007,0.0020962548,0.29929757,0.004383204,0.0010553173,0.0024130687,0.4755782,0.0038679885,0.0011275994,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816,0.0000015721816},
{0.004665822,0.00425969,0.4009772,0.0060747294,0.0033526511,0.0033080908,0.33871362,0.0039439793,0.0031611212,0.005089144,0.22288343,0.0034499145,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491,0.000002318491},
{0.0027156894,0.0020988584,0.012151249,0.31754428,0.0023619812,0.001804296,0.009246164,0.33430964,0.0035059329,0.003815019,0.0070857103,0.3032368,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959,0.0000023914959},
{0.1882832,0.002427066,0.0019210996,0.004716409,0.28868145,0.0021628516,0.000883265,0.004151549,0.4983172,0.0040193717,0.00053235964,0.0037545254,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991,0.0000028779991},
{0.0019583458,0.13125494,0.0018911836,0.0030455918,0.001594573,0.2499033,0.0016139019,0.002956766,0.001796494,0.59839183,0.0023447592,0.0031326257,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715,0.0000022260715},
{0.0018816346,0.0018150989,0.25813177,0.0052019586,0.0013588285,0.001273152,0.33513173,0.004554965,0.0014111687,0.0017763132,0.382982,0.0043837493,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675,0.0000018774675},
{0.0020127755,0.0018369668,0.0071376953,0.23631942,0.0018852145,0.0018060311,0.006016329,0.31863108,0.0029892689,0.0037514248,0.0056734323,0.4118478,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135,0.0000017789135} 
},
{
 {0.3850458,0.00020087897,0.00020087897,0.00020087897,0.34318456,0.00020087897,0.00020087897,0.00020087897,0.25951603,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897,0.00020087897},
{0.24293107,0.13234207,0.000022313618,0.000022313618,0.22539148,0.113385834,0.000022313618,0.000022313618,0.19359839,0.09105697,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618,0.000022313618},
{0.30578205,0.000032703876,0.10363858,0.000032703876,0.2792552,0.000032703876,0.05468487,0.000032703876,0.22840467,0.000032703876,0.026337788,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876,0.000032703876},
{0.2541438,0.000021991626,0.000021991626,0.1368952,0.23553622,0.000021991626,0.000021991626,0.09608302,0.21628657,0.000021991626,0.000021991626,0.059779678,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626,0.000021991626},
{0.21709274,0.10759749,0.000015527427,0.000015527427,0.20096391,0.11093703,0.000015527427,0.000015527427,0.19338539,0.16912284,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427,0.000015527427},
{0.0005356256,0.34521726,0.0005356256,0.0005356256,0.0005356256,0.2828626,0.0005356256,0.0005356256,0.0005356256,0.339247,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256,0.0005356256},
{0.000028561815,0.16307473,0.17959669,0.000028561815,0.000028561815,0.17441098,0.13806503,0.000028561815,0.000028561815,0.25134814,0.09184783,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815,0.000028561815},
{0.000034684184,0.13310944,0.000034684184,0.1709778,0.000034684184,0.14351554,0.000034684184,0.15850925,0.000034684184,0.22602752,0.000034684184,0.16584876,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184,0.000034684184},
{0.2489779,0.000026759957,0.13231885,0.000026759957,0.22062998,0.000026759957,0.10883405,0.000026759957,0.19748457,0.000026759957,0.09020259,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957,0.000026759957},
{0.000029961277,0.18735445,0.17742118,0.000029961277,0.000029961277,0.16563033,0.14077343,0.000029961277,0.000029961277,0.21548004,0.111602835,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277,0.000029961277},
{0.0005026851,0.0005026851,0.44311076,0.0005026851,0.0005026851,0.0005026851,0.31259656,0.0005026851,0.0005026851,0.0005026851,0.2136289,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851,0.0005026851},
{0.000040513514,0.000040513514,0.16612616,0.20399147,0.000040513514,0.000040513514,0.13553154,0.19106865,0.000040513514,0.000040513514,0.109337084,0.19159532,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514,0.000040513514},
{0.18651135,0.000022714883,0.000022714883,0.09760197,0.2038428,0.000022714883,0.000022714883,0.09527121,0.31669146,0.000022714883,0.000022714883,0.09876376,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883,0.000022714883},
{0.00002353449,0.15897433,0.00002353449,0.10862832,0.00002353449,0.1717834,0.00002353449,0.104488544,0.00002353449,0.3419326,0.00002353449,0.11282779,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449,0.00002353449},
{0.000028957911,0.000028957911,0.17208768,0.17360197,0.000028957911,0.000028957911,0.1674643,0.14660825,0.000028957911,0.000028957911,0.19304402,0.1455142,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911,0.000028957911},
{0.00033585634,0.00033585634,0.00033585634,0.3189079,0.00033585634,0.00033585634,0.00033585634,0.31495953,0.00033585634,0.00033585634,0.00033585634,0.34564534,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634,0.00033585634} 
},
{
 {0.000060802984,0.3715952,0.16756116,0.11477379,0.000060802984,0.09431433,0.059496462,0.05590019,0.000060802984,0.07188693,0.028221482,0.03290628,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984,0.000060802984},
{0.00018286836,0.00018286836,0.30743292,0.2754265,0.00018286836,0.00018286836,0.13324858,0.12251734,0.00018286836,0.00018286836,0.070935085,0.07983319,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836,0.00018286836},
{0.00010229005,0.22456907,0.00010229005,0.48023182,0.00010229005,0.104320884,0.00010229005,0.0622173,0.00010229005,0.087807275,0.00010229005,0.034920827,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005,0.00010229005},
{0.00011976398,0.25759187,0.29371092,0.00011976398,0.00011976398,0.12771514,0.11453526,0.00011976398,0.00011976398,0.1368318,0.06266869,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398,0.00011976398},
{0.00018212914,0.00018212914,0.44730917,0.21552096,0.00018212914,0.00018212914,0.11785532,0.082855426,0.00018212914,0.00018212914,0.07251849,0.053377163,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914,0.00018212914},
{0.23808336,0.00012316936,0.17480735,0.10791738,0.12475854,0.00012316936,0.09289373,0.053407434,0.094897486,0.00012316936,0.06345025,0.043010138,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936,0.00012316936},
{0.49558014,0.00009108541,0.00009108541,0.27728397,0.07907324,0.00009108541,0.00009108541,0.053513788,0.05304947,0.00009108541,0.00009108541,0.036216445,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541,0.00009108541},
{0.2717039,0.0001690624,0.32772952,0.0001690624,0.08374362,0.0001690624,0.1358602,0.0001690624,0.07014028,0.0001690624,0.10101685,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624,0.0001690624},
{0.00012984093,0.5105029,0.00012984093,0.1725491,0.00012984093,0.10271051,0.00012984093,0.07033895,0.00012984093,0.09033762,0.00012984093,0.046030194,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093,0.00012984093},
{0.2391572,0.00011319025,0.00011319025,0.41891438,0.105162024,0.00011319025,0.00011319025,0.09759484,0.07816477,0.00011319025,0.00011319025,0.05444175,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025,0.00011319025},
{0.18064266,0.1483027,0.000077102886,0.28039876,0.06961826,0.07151575,0.000077102886,0.0627373,0.05612526,0.07854152,0.000077102886,0.047877133,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886,0.000077102886},
{0.31550118,0.2583336,0.0001828863,0.0001828863,0.10955336,0.090609014,0.0001828863,0.0001828863,0.10382589,0.11156957,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863,0.0001828863},
{0.00016590861,0.30219242,0.29855457,0.00016590861,0.00016590861,0.10981936,0.107982226,0.00016590861,0.00016590861,0.11142989,0.06039883,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861,0.00016590861},
{0.21991178,0.00015108133,0.32871982,0.00015108133,0.11304569,0.00015108133,0.13998975,0.00015108133,0.09199748,0.00015108133,0.09757275,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133,0.00015108133},
{0.29074508,0.30756015,0.00016010621,0.00016010621,0.10952437,0.10467823,0.00016010621,0.00016010621,0.08341924,0.094786786,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621,0.00016010621},
{0.13814808,0.1224966,0.277918,0.000083328254,0.07566409,0.05685629,0.096876204,0.000083328254,0.08117798,0.07268459,0.07359511,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254,0.000083328254} 

}};
// match, branch, stick, dark
// [context_num, state_num, feature_num], the last feature is 1!, it is used as bias
static constexpr const double transProbs[CONTEXT_NUMBER][4][4] = {
 {{0.5084407620610049, 0.32651040957977234, -0.05329488080311954, 1.482026603075654},
{-0.20210351343090782, -0.38387566424403713, 0.005437117133034808, -0.32723831439108525},
{-0.2197976440383137, -0.14848781607053715, 0.028419017840971162, -0.17434436210810902},
{-0.08653960459196637, 0.20585307073544346, 0.019438745829126806, -0.9804439265782625}} ,//A:A   ['Match', 'Branch', 'Stick', 'Dark']

{{2.14204318194741, 0.08896260912651714, -0.006967838218874539, 0.0890841830084649},
{-5.08162446898635, 0.8807745768201218, -0.1889450390462398, 2.9357605563855085},
{0.22547144197189758, -0.6917371063754991, 0.12050912199338445, -0.2672514603178293},
{2.7141098450620644, -0.2780000795711307, 0.07540375527162617, -2.7575932790720863}} ,//A:C   ['Match', 'Branch', 'Stick', 'Dark']

{{2.2156057932741233, -0.19329807288173123, 0.06085817271245403, 0.24565193879909258},
{-4.091231152673129, 0.9237908498990883, -0.3059417877000108, 2.5827056926163885},
{-1.4356934040312035, -0.05064596873526226, 0.08150793658544819, -0.5398324458291166},
{3.311318763428232, -0.6798468082808876, 0.16357567840173073, -2.2885251855829707}} ,//A:G   ['Match', 'Branch', 'Stick', 'Dark']

{{3.1632638101599246, -0.17334489830917302, 0.09073314610726113, -0.7363694640652202},
{-1.6061601983902913, 0.32891097032132166, -0.2739161355228605, 2.387783857879833},
{-3.147406725484646, 0.10595414188071596, 0.020525181637104286, 0.5197895674394638},
{1.5903031137159072, -0.2615202138924771, 0.16265780777919683, -2.1712039612557326}} ,//A:T   ['Match', 'Branch', 'Stick', 'Dark']

{{1.4462080983203933, 0.42327823630357975, 0.016840788416561177, -0.7474689507369346},
{-2.08829813532637, 0.14533434711256846, -0.2398054754915743, 3.5787735200933146},
{-0.2673098608518763, -0.6551913953800482, 0.1345763979635956, -0.5047052255517814},
{0.9093998978592829, 0.08657881196382655, 0.08838828911161509, -2.3265993438067745}} ,//C:A   ['Match', 'Branch', 'Stick', 'Dark']

{{0.9012156749837436, 0.4003580090415776, -0.08087877479620607, 1.273022257145879},
{-0.8234913887397126, -0.6878418220380131, 0.12085780084507441, 0.23806232494695018},
{-2.2462024194912824, -0.1875228625714294, 0.026431773620748958, 1.7995905104949728},
{2.16847813324933, 0.4750066755682291, -0.06641079967061653, -3.310675092583861}} ,//C:C   ['Match', 'Branch', 'Stick', 'Dark']

{{2.2387290358047935, -0.19257924290069697, 0.05993275715868586, 0.38902352749140884},
{-5.344807405010195, 1.0709695327552264, -0.30470404308471494, 3.16194834506703},
{-0.5919553477214035, -0.1807746500896464, 0.09005200830029647, -1.0618388463343602},
{3.6980337169291735, -0.6976156397666101, 0.1547192776303838, -2.489133026278267}} ,//C:G   ['Match', 'Branch', 'Stick', 'Dark']

{{3.763053321222141, -0.029245342266473188, 0.047541063005426695, -1.3121383553733852},
{-2.9470123825812533, -0.050084468472549395, -0.17487475516079118, 4.200497497302886},
{-3.2590536370721814, 0.29731266669857753, 0.014135444766903538, 0.0050377670956040154},
{2.4430126984285114, -0.217982855959077, 0.11319824738954144, -2.89339690902177}} ,//C:T   ['Match', 'Branch', 'Stick', 'Dark']

{{1.3517375019540026, 0.4104597415189977, 0.016735790717857166, -0.663126525728736},
{-1.3469007398718371, 0.1026344091819823, -0.2839045323854538, 2.963306580149621},
{-0.4838688103681325, -0.6025783717888984, 0.16379113344855875, -0.25182593941740544},
{0.4790320482856218, 0.08948422108732731, 0.10337760821918646, -2.0483541150034887}} ,//G:A   ['Match', 'Branch', 'Stick', 'Dark']

{{2.8598441377629293, 0.16168665485573877, -0.04566051478162529, -0.36073106079782136},
{-6.741124770183844, 0.44741464921046853, -0.07495083998289562, 4.8223801633830155},
{0.44427463552941643, -0.48153854195489676, 0.11007689709112625, -0.99049178722329},
{3.4370059968903286, -0.12756276211127857, 0.010534457672641901, -3.471157315362416}} ,//G:C   ['Match', 'Branch', 'Stick', 'Dark']

{{1.6071909093103458, 0.2902646117152608, -0.07659651773513035, 0.8403095398426811},
{-1.2682759444431926, -0.4412802365327305, 0.10094175909998587, -0.4711773585365871},
{-4.336511344496729, 0.28099400600210295, -0.04194866997826728, 2.8617061971352267},
{3.9975963796325873, -0.12997838118325714, 0.0176034286144075, -3.2308383784445054}} ,//G:G   ['Match', 'Branch', 'Stick', 'Dark']

{{2.609505571840115, 0.043926202956058855, 0.06960811205704853, -0.6253331566179393},
{-3.1228181126656254, 0.5859288483470246, -0.27734139690719595, 2.648333715642968},
{-0.750083778073777, -0.415943005885852, 0.05027169161396784, 0.059439815199962394},
{1.2633963188982213, -0.21391204541687625, 0.15746159323630726, -2.082440374227192}} ,//G:T   ['Match', 'Branch', 'Stick', 'Dark']

{{1.8198160224241697, 0.5552398166321024, -0.01330157459915621, -1.4155373568920648},
{-2.430608242302687, 0.13799721989405359, -0.23950509173222592, 3.912611194711883},
{-1.1228355817856837, -0.7961671343279518, 0.14151647081924584, 1.2399954363871002},
{1.7336278016672735, 0.10293009780072429, 0.11129019551235891, -3.737069274214163}} ,//T:A   ['Match', 'Branch', 'Stick', 'Dark']

{{3.2903004596107794, 0.15960600289241045, -0.037491047574050355, -0.9054840959550416},
{-6.252317648061135, 0.777665469737259, -0.15885530988088936, 4.216311609802032},
{-1.3282449644451797, -0.6147341144671126, 0.1304253019148166, 1.0479158825083883},
{4.290262152897471, -0.322537358160098, 0.06592105554042565, -4.358743396348192}} ,//T:C   ['Match', 'Branch', 'Stick', 'Dark']

{{3.221793265195747, -0.11843271053323307, 0.049394161324275244, -0.4882194089121562},
{-4.40623126366084, 0.954834498662224, -0.27889171452918593, 2.767961933220944},
{-2.6066910114399042, -0.38279536337413445, 0.0939234990809656, 1.32117731828892},
{3.791129009910766, -0.45360642475484825, 0.13557405412397228, -3.600919842593418}} ,//T:G   ['Match', 'Branch', 'Stick', 'Dark']

{{2.7134372305159404, 0.10485656738528082, -0.016305695899900555, 0.32974013267795405},
{-1.8079114494674497, -0.10969499376494427, -0.0329494922511919, 0.21526008290482057},
{-3.2104764817651565, 0.04390122500195263, -0.01570403472964097, 2.1790356977805287},
{2.3049507007186416, -0.03906279862259947, 0.06495922288137607, -2.7240359133658574}} ,//T:T   ['Match', 'Branch', 'Stick', 'Dark']

};

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model::Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model(const NucleotideLevelFeats& feats){
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)

        const double cr = feats.crs[bp];
        const double dw_mean = feats.dw_means[bp];
        const double dw_var = feats.dw_vars[bp];

        Eigen::Matrix<double, 4, 1> features = {cr, std::log(dw_mean + 1.0), std::log(dw_var + 1.0), 1.0};
        // Eigen::MatrixXd weights(transProbs[ctx], 4, 4);
        const int state_num = 4;
        const int features_num = 4;
        constexpr int elements_num = state_num * features_num;
        double ori_weights[elements_num];
        for (int row=0; row < state_num; row++) {
            for (int col=0; col < features_num; col++) {
                int ele_idx = row * state_num + col;
                ori_weights[ele_idx] = transProbs[ctx][row][col];
            }
        }
        Eigen::Matrix<double, 4, 4> weights = Eigen::Map<Eigen::Matrix<double, 4, 4>>(ori_weights, 4, 4);

        Eigen::Matrix<double, 4, 1> logits = weights.transpose() * features;
        Eigen::Matrix<double, 4, 1> exp_values = logits.array().exp();
        auto probs = exp_values / exp_values.sum();

        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] = probs(j, 0);

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor::Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {18, 46};
    std::vector<uint8_t> cr_boundaries = {255};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }

    Data::NucleotideLevelFeats feats;
    const Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model model{feats};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_InitialiseModel,
                            Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(Kit__500_Chem__2_BC__1_PW3_v2_Trans_v1_t_0_0_1)

}  // namespace Consensus
}  // namespace PacBio
