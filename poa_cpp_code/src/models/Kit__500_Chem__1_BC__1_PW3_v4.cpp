// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace Kit__500_Chem__1_BC__1_PW3_v4 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class Kit__500_Chem__1_BC__1_PW3_v4_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"Kit__500_Chem__1_BC__1_PW3_v4"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    Kit__500_Chem__1_BC__1_PW3_v4_Model(const NucleotideLevelFeats& feats);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class Kit__500_Chem__1_BC__1_PW3_v4_Recursor : public Recursor<Kit__500_Chem__1_BC__1_PW3_v4_Recursor>
{
public:
    Kit__500_Chem__1_BC__1_PW3_v4_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
		// match

 {0.36468896,0.0030520505,0.0043537556,0.0039294846,0.41838062,0.0011732698,0.004310496,0.002621421,0.1926729,0.0011860325,0.0024233193,0.0012076031,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256,0.0000000015762256},
{0.004654086,0.24168907,0.0013304491,0.0014301458,0.005122784,0.38100687,0.000569624,0.0009266688,0.004093472,0.3581963,0.00036286793,0.00061747804,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864,0.0000000030728864},
{0.005909179,0.0017916437,0.46333018,0.0036628277,0.0064718965,0.001132913,0.39643326,0.000997372,0.0048007863,0.0011780316,0.113589756,0.000702031,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909,0.0000000022335909},
{0.0052785384,0.0010868794,0.0019261523,0.45495346,0.005866699,0.0008172128,0.0015376648,0.39063916,0.005100589,0.0012219704,0.001175876,0.13039565,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952,0.0000000020781952},
{0.30342987,0.0033113067,0.004117198,0.0026614657,0.39441216,0.0039413306,0.0037784723,0.0019143687,0.2719242,0.006272293,0.002892542,0.0013446409,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834,0.0000000022379834},
{0.0032875396,0.16966958,0.0014594119,0.00171178,0.0022238246,0.29687926,0.0004215169,0.0012895424,0.0014256533,0.5204849,0.0002542616,0.00089258776,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653,0.0000000028261653},
{0.0039577107,0.0029035478,0.3821808,0.002190157,0.0011210783,0.0037959802,0.3892875,0.0009794506,0.00073035515,0.0059774322,0.20634083,0.0005342503,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266,0.000000016518266},
{0.0017874602,0.0016837176,0.0015958454,0.34426945,0.0012565028,0.0024127776,0.0012848302,0.38649735,0.0011041997,0.004452434,0.001120491,0.25253487,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595,0.0000000021911595},
{0.3070141,0.0022463866,0.006855732,0.0027060627,0.3873343,0.00074747286,0.0070818937,0.001796523,0.27724153,0.0007867119,0.004896632,0.0012924833,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207,0.000000002727207},
{0.0013825353,0.14017488,0.002222694,0.0019833804,0.0010099069,0.27255216,0.001944875,0.0007832949,0.0008810655,0.5751736,0.0013662917,0.00052510225,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029,0.000000003542029},
{0.003243809,0.0017567679,0.34798527,0.003957822,0.0020728689,0.0013398746,0.38850906,0.0014487575,0.0013988224,0.0019900855,0.24537191,0.0009248423,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963,0.0000000028368963},
{0.001756495,0.00081412407,0.002715913,0.3025888,0.001480728,0.0007703052,0.0029314596,0.37921557,0.001549277,0.0015513184,0.0025537407,0.30207208,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588,0.0000000030743588},
{0.15462841,0.0010882453,0.002027237,0.0041847723,0.32088533,0.0005567396,0.0027899086,0.004569355,0.49921605,0.0006616966,0.00504022,0.004351954,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731,0.00000000248731},
{0.0009231005,0.09409546,0.00053108844,0.0017728778,0.00069745374,0.22438431,0.00023188588,0.0019602035,0.0005829658,0.67279834,0.00021567244,0.0018065412,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065,0.0000000025549065},
{0.0010969811,0.0007150667,0.20070331,0.0026946082,0.00076465815,0.0006452036,0.36060342,0.0023022613,0.00070444285,0.0012024584,0.42667046,0.0018970493,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723,0.0000000021264723},
{0.0015518323,0.0007242123,0.0011382205,0.23535705,0.0015846755,0.00080641115,0.001231253,0.36290044,0.002144752,0.0019194884,0.0016164702,0.38902512,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914,0.0000000015489914} 

		},

{ // branch
  
{0.3758565,0.00000022236884,0.00000022236884,0.00000022236884,0.40015206,0.00000022236884,0.00000022236884,0.00000022236884,0.2239779,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884,0.00000022236884},
{0.060551718,0.30166185,0.000000082592976,0.000000082592976,0.060042698,0.2741797,0.000000082592976,0.000000082592976,0.043889165,0.25967008,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976,0.000000082592976},
{0.08882081,0.00000010177166,0.39686644,0.00000010177166,0.08765339,0.00000010177166,0.2520021,0.00000010177166,0.06357635,0.00000010177166,0.111075014,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166,0.00000010177166},
{0.055052362,0.0000000635721,0.0000000635721,0.3992791,0.05812181,0.0000000635721,0.0000000635721,0.29304534,0.046635605,0.0000000635721,0.0000000635721,0.1478621,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721,0.0000000635721},
{0.3391614,0.022876883,0.000000024070363,0.000000024070363,0.32933983,0.020789959,0.000000024070363,0.000000024070363,0.25486916,0.03296143,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363,0.000000024070363},
{0.0000009826446,0.2967842,0.0000009826446,0.0000009826446,0.0000009826446,0.29532695,0.0000009826446,0.0000009826446,0.0000009826446,0.40782893,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446,0.0000009826446},
{0.00000061381775,0.048568945,0.3905514,0.00000061381775,0.00000061381775,0.041830454,0.28949365,0.00000061381775,0.00000061381775,0.055633374,0.1738866,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775,0.00000061381775},
{0.00000006024256,0.030341769,0.00000006024256,0.33828193,0.00000006024256,0.027662901,0.00000006024256,0.3127349,0.00000006024256,0.042688783,0.00000006024256,0.24828622,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256,0.00000006024256},
{0.33072078,0.000000038872624,0.029437616,0.000000038872624,0.33256,0.000000038872624,0.020150559,0.000000038872624,0.2732216,0.000000038872624,0.013907109,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624,0.000000038872624},
{0.00000010816668,0.26290637,0.051532447,0.00000010816668,0.00000010816668,0.24453934,0.026300404,0.00000010816668,0.00000010816668,0.39855754,0.016157614,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668,0.00000010816668},
{0.00000092235354,0.00000092235354,0.42862138,0.00000092235354,0.00000092235354,0.00000092235354,0.35108924,0.00000092235354,0.00000092235354,0.00000092235354,0.22023311,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354,0.00000092235354},
{0.000000095576056,0.000000095576056,0.026480874,0.30892044,0.000000095576056,0.000000095576056,0.022347497,0.33018735,0.000000095576056,0.000000095576056,0.018631596,0.2934267,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056,0.000000095576056},
{0.2351701,0.00000002210091,0.00000002210091,0.021556564,0.29572847,0.00000002210091,0.00000002210091,0.021115826,0.4098206,0.00000002210091,0.00000002210091,0.016607197,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091,0.00000002210091},
{0.000000043639854,0.18515639,0.000000043639854,0.023313021,0.000000043639854,0.2158778,0.000000043639854,0.021642357,0.000000043639854,0.53560257,0.000000043639854,0.018405326,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854,0.000000043639854},
{0.00000006303667,0.00000006303667,0.2876703,0.039013017,0.00000006303667,0.00000006303667,0.29582334,0.028726188,0.00000006303667,0.00000006303667,0.32827455,0.020488935,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667,0.00000006303667},
{0.00000048146734,0.00000048146734,0.00000048146734,0.29721606,0.00000048146734,0.00000048146734,0.00000048146734,0.3582801,0.00000048146734,0.00000048146734,0.00000048146734,0.3444745,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734,0.00000048146734} 

	},


    {// stickPmf

 {0.00000006733775,0.34920764,0.21188436,0.12726815,0.00000006733775,0.048161373,0.08477224,0.06369323,0.00000006733775,0.03709428,0.045335546,0.032579485,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775,0.00000006733775},
{0.0000002617601,0.0000002617601,0.28750736,0.360307,0.0000002617601,0.0000002617601,0.10654107,0.12186817,0.0000002617601,0.0000002617601,0.064108714,0.059652507,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601,0.0000002617601},
{0.00000011051145,0.13178071,0.00000011051145,0.6835228,0.00000011051145,0.052494153,0.00000011051145,0.059852783,0.00000011051145,0.039138183,0.00000011051145,0.033204935,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145,0.00000011051145},
{0.0000003127907,0.22433537,0.27528554,0.0000003127907,0.0000003127907,0.09522975,0.1711722,0.0000003127907,0.0000003127907,0.09395513,0.14000386,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907,0.0000003127907},
{0.00000016162964,0.00000016162964,0.5852446,0.16529217,0.00000016162964,0.00000016162964,0.089131474,0.070834674,0.00000016162964,0.00000016162964,0.048385773,0.041101933,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964,0.00000016162964},
{0.26694268,0.00000021755896,0.25056723,0.18454331,0.08342494,0.00000021755896,0.04041767,0.06322546,0.049851898,0.00000021755896,0.021114968,0.03989988,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896,0.00000021755896},
{0.7146972,0.00000066187556,0.00000066187556,0.17791347,0.03652891,0.00000066187556,0.00000066187556,0.032178406,0.02094042,0.00000066187556,0.00000066187556,0.017703187,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556,0.00000066187556},
{0.48288375,0.00000019958212,0.25597104,0.00000019958212,0.075423874,0.00000019958212,0.071698874,0.00000019958212,0.057826124,0.00000019958212,0.05618476,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212,0.00000019958212},
{0.00000019115112,0.61178356,0.00000019115112,0.18584113,0.00000019115112,0.05870251,0.00000019115112,0.06405053,0.00000019115112,0.042681176,0.00000019115112,0.036930013,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112,0.00000019115112},
{0.19329403,0.00000018576925,0.00000018576925,0.55050695,0.06171719,0.00000018576925,0.00000018576925,0.12614736,0.029074932,0.00000018576925,0.00000018576925,0.039248772,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925,0.00000018576925},
{0.23943856,0.08154247,0.00000011937976,0.46371374,0.056372438,0.03127475,0.00000011937976,0.037739288,0.03658345,0.03145609,0.00000011937976,0.021872642,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976,0.00000011937976},
{0.46876574,0.23873933,0.00000031575433,0.00000031575433,0.09084979,0.059318874,0.00000031575433,0.00000031575433,0.075308986,0.066998966,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433,0.00000031575433},
{0.00000021158442,0.29309815,0.3604952,0.00000021158442,0.00000021158442,0.07164756,0.11926019,0.00000021158442,0.00000021158442,0.060183495,0.095303126,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442,0.00000021158442},
{0.26355875,0.0000003268273,0.39969343,0.0000003268273,0.119723044,0.0000003268273,0.08815447,0.0000003268273,0.08065444,0.0000003268273,0.048196893,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273,0.0000003268273},
{0.42428038,0.18832617,0.0000002594346,0.0000002594346,0.12329032,0.08416655,0.0000002594346,0.0000002594346,0.08607158,0.09384995,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346,0.0000002594346},
{0.2690925,0.10873317,0.121031635,0.00000014259751,0.11250887,0.051610034,0.0738715,0.00000014259751,0.11505965,0.0749859,0.073098905,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751,0.00000014259751} 

}};

static constexpr const double transProbs[CONTEXT_NUMBER][4] = {
{0.9526007,0.006752261,0.02229815,0.018348927}, // AA
{0.9212281,0.03427428,0.010814415,0.033683185}, // AC
{0.9039687,0.019839346,0.018270344,0.057921663}, // AG
{0.91036725,0.029760119,0.0060483995,0.053824246}, // AT
{0.8326631,0.07741817,0.011529242,0.07838955}, // CA
{0.975279,0.0028048053,0.012669032,0.009247204}, // CC
{0.88551974,0.023829047,0.022098787,0.06855247}, // CG
{0.91346633,0.03322473,0.010028579,0.04328031}, // CT
{0.84840256,0.05952168,0.012104252,0.079971574}, // GA
{0.9191613,0.030098679,0.017525278,0.033214774}, // GC
{0.962571,0.0029604195,0.022874009,0.011594475}, // GG
{0.9239648,0.029720653,0.008996053,0.037318453}, // GT
{0.8320916,0.09364624,0.009781637,0.06448047}, // TA
{0.9136169,0.053487796,0.007141868,0.025753457}, // TC
{0.92215157,0.03110764,0.0075583495,0.039182402}, // TG
{0.9798959,0.003152454,0.010644201,0.0063074077}, // TT
    };

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

Kit__500_Chem__1_BC__1_PW3_v4_Model::Kit__500_Chem__1_BC__1_PW3_v4_Model(const NucleotideLevelFeats& feats){
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)
        double sum = 0.0;

        // cached transitions
        for (size_t j = 0; j < 4; ++j) {
            double xb = transProbs[ctx][j];
            ctxTrans_[ctx][j] = xb;
            sum += xb;
        }
        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] /= sum;

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> Kit__500_Chem__1_BC__1_PW3_v4_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<Kit__500_Chem__1_BC__1_PW3_v4_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> Kit__500_Chem__1_BC__1_PW3_v4_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double Kit__500_Chem__1_BC__1_PW3_v4_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

Kit__500_Chem__1_BC__1_PW3_v4_Recursor::Kit__500_Chem__1_BC__1_PW3_v4_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<Kit__500_Chem__1_BC__1_PW3_v4_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> Kit__500_Chem__1_BC__1_PW3_v4_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {18, 46};
    std::vector<uint8_t> cr_boundaries = {255};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double Kit__500_Chem__1_BC__1_PW3_v4_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double Kit__500_Chem__1_BC__1_PW3_v4_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> Kit__500_Chem__1_BC__1_PW3_v4_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }


    Data::NucleotideLevelFeats feats;

    const Kit__500_Chem__1_BC__1_PW3_v4_Model model{feats};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData Kit__500_Chem__1_BC__1_PW3_v4_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> Kit__500_Chem__1_BC__1_PW3_v4_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, Kit__500_Chem__1_BC__1_PW3_v4_InitialiseModel,
                            Kit__500_Chem__1_BC__1_PW3_v4_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(Kit__500_Chem__1_BC__1_PW3_v4)

}  // namespace Consensus
}  // namespace PacBio
