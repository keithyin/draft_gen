// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace Kit__500_Chem__1_BC__1_PW3_v2 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class Kit__500_Chem__1_BC__1_PW3_v2_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"Kit__500_Chem__1_BC__1_PW3_v2"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    Kit__500_Chem__1_BC__1_PW3_v2_Model(const NucleotideLevelFeats& feats);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class Kit__500_Chem__1_BC__1_PW3_v2_Recursor : public Recursor<Kit__500_Chem__1_BC__1_PW3_v2_Recursor>
{
public:
    Kit__500_Chem__1_BC__1_PW3_v2_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
		// match

{0.32939643,0.00511995,0.003728639,0.0056244037,0.33321488,0.0029411798,0.0020555658,0.00414915,0.30583322,0.0028402715,0.0015103404,0.0033966005,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943},
{0.009813955,0.2534213,0.0027426877,0.0033454306,0.008809807,0.34054533,0.0016258134,0.0021349834,0.011316428,0.36208668,0.0016058527,0.0023057451,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562},
{0.012473472,0.0035702572,0.42929038,0.004030346,0.011316705,0.002056852,0.31517398,0.0023284454,0.013343998,0.003191841,0.1998141,0.003133244,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975},
{0.009300954,0.0023736013,0.0023574645,0.36033168,0.0079249,0.0013863386,0.0013854894,0.34099534,0.0100693805,0.0022753656,0.0019286631,0.25946963,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278},
{0.25077775,0.0046748496,0.0027825013,0.0036631927,0.29763997,0.004735742,0.0014420255,0.002574343,0.41915634,0.008496363,0.0011412172,0.002715988,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905},
{0.007507076,0.16880253,0.006006677,0.004352218,0.005581203,0.25485194,0.0041151405,0.0031954064,0.0066032675,0.5308402,0.003722308,0.0041812146,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086},
{0.0057576983,0.005975693,0.3088681,0.003269212,0.0024264052,0.0059328233,0.30165416,0.0021168008,0.0025176588,0.01005596,0.34860054,0.002635328,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897},
{0.0037630883,0.0028654002,0.0025846658,0.2357347,0.0027301772,0.0025850332,0.0018481672,0.28614658,0.0040274095,0.005132586,0.002587238,0.44973382,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605},
{0.27644995,0.0033983784,0.008233246,0.0038908112,0.3027401,0.0017637557,0.0065968055,0.0027752211,0.38099873,0.0021424016,0.008080811,0.0026874652,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074},
{0.0035983857,0.169011,0.0070038345,0.0037008955,0.0024740875,0.2627832,0.005572084,0.001960615,0.0036901212,0.53038794,0.006987981,0.002665793,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311},
{0.008761706,0.0061317026,0.29026803,0.007679032,0.0057611084,0.004241925,0.2737431,0.006374676,0.006778468,0.007537578,0.3734548,0.009011415,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632},
{0.005959931,0.0023007982,0.005846242,0.24682194,0.0048198514,0.0012779426,0.0047163116,0.2872748,0.0074655926,0.002989772,0.0069841547,0.42329955,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602},
{0.16259353,0.0020221071,0.0016208083,0.0066679176,0.23454992,0.0012459533,0.0006972443,0.0069507817,0.5701858,0.0016388125,0.00073873857,0.01078851,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995},
{0.002135965,0.10766023,0.001526755,0.0048903297,0.001578973,0.20847255,0.0008652188,0.004852815,0.002596089,0.65645546,0.0010024128,0.0077326973,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843},
{0.002881206,0.0018839262,0.21211006,0.0065877186,0.0018678963,0.0010789118,0.25079253,0.006831688,0.002456183,0.0017941404,0.500943,0.010575171,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855},
{0.003264006,0.0015228865,0.0018512108,0.18899369,0.0030910298,0.0011626957,0.0012123596,0.26190823,0.005793647,0.0028220308,0.002172162,0.52602535,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811}

		},

{ // branch
  
{0.32945517,0.0003551844,0.0003551844,0.0003551844,0.31554234,0.0003551844,0.0003551844,0.0003551844,0.33333623,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844},
{0.22083373,0.09757665,0.00005974229,0.00005974229,0.21871217,0.09041923,0.00005974229,0.00005974229,0.27279058,0.096202575,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229},
{0.2325229,0.00007106976,0.13970928,0.00007106976,0.21863484,0.00007106976,0.08757354,0.00007106976,0.25184867,0.00007106976,0.06558872,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976},
{0.20030588,0.0000390692,0.0000390692,0.1542757,0.16855215,0.0000390692,0.0000390692,0.13088945,0.21476148,0.0000390692,0.0000390692,0.12894933,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692},
{0.2079457,0.07176451,0.00004588881,0.00004588881,0.20787631,0.0717757,0.00004588881,0.00004588881,0.29387754,0.1440987,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881},
{0.00087254465,0.23743854,0.00087254465,0.00087254465,0.00087254465,0.27265957,0.00087254465,0.00087254465,0.00087254465,0.43667668,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465},
{0.000062078325,0.09610784,0.22845428,0.000062078325,0.000062078325,0.090585895,0.19226262,0.000062078325,0.000062078325,0.16706488,0.22192395,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325},
{0.0000694107,0.089614294,0.0000694107,0.1777405,0.0000694107,0.070908956,0.0000694107,0.18685362,0.0000694107,0.13973051,0.0000694107,0.3311263,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107},
{0.20032601,0.00004954168,0.13826236,0.00004954168,0.17695442,0.00004954168,0.11633957,0.00004954168,0.21264134,0.00004954168,0.15260287,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168},
{0.000067560664,0.11582369,0.23127992,0.000067560664,0.000067560664,0.09351714,0.17876881,0.000067560664,0.000067560664,0.15269864,0.22399326,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664},
{0.00066328014,0.00066328014,0.36404374,0.00066328014,0.00066328014,0.00066328014,0.2767496,0.00066328014,0.00066328014,0.00066328014,0.31874657,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014},
{0.00005219878,0.00005219878,0.14509605,0.15722145,0.00005219878,0.00005219878,0.113716945,0.16565345,0.00005219878,0.00005219878,0.14398079,0.27130377,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878},
{0.14789075,0.000041242547,0.000041242547,0.09218011,0.15414453,0.000041242547,0.000041242547,0.105847485,0.32092032,0.000041242547,0.000041242547,0.17662473,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547},
{0.0000593167,0.09314458,0.0000593167,0.13729936,0.0000593167,0.09594404,0.0000593167,0.14588436,0.0000593167,0.26814476,0.0000593167,0.25614253,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167},
{0.000040569717,0.000040569717,0.15474181,0.12115404,0.000040569717,0.000040569717,0.14070171,0.1254,0.000040569717,0.000040569717,0.2535182,0.2021312,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717},
{0.00041754078,0.00041754078,0.00041754078,0.25045317,0.00041754078,0.00041754078,0.00041754078,0.26834634,0.00041754078,0.00041754078,0.00041754078,0.4557305,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078}

	},


    {// stickPmf

    {0.000101342164,0.23210075,0.1448056,0.1309934,0.000101342164,0.091484785,0.069466345,0.09003387,0.000101342164,0.090641916,0.058682058,0.08621746,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164},
{0.0002446505,0.0002446505,0.24459083,0.26347667,0.0002446505,0.0002446505,0.10226988,0.1418794,0.0002446505,0.0002446505,0.0878713,0.1457222,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505},
{0.00022331519,0.22609302,0.00022331519,0.3049723,0.00022331519,0.12088433,0.00022331519,0.1001378,0.00022331519,0.13480613,0.00022331519,0.10015414,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519},
{0.00015667213,0.32113966,0.220816,0.00015667213,0.00015667213,0.13909428,0.08648302,0.00015667213,0.00015667213,0.14679797,0.076582104,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213},
{0.00025784704,0.00025784704,0.2944173,0.23377293,0.00025784704,0.00025784704,0.11146539,0.1257413,0.00025784704,0.00025784704,0.09245389,0.12719406,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704},
{0.16737722,0.00014269158,0.15576701,0.13336442,0.1030094,0.00014269158,0.08214162,0.072480366,0.11388528,0.00014269158,0.078703105,0.08542354,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158},
{0.48987594,0.00014613161,0.00014613161,0.19125064,0.08665961,0.00014613161,0.00014613161,0.06969052,0.08235051,0.00014613161,0.00014613161,0.07169716,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161},
{0.38660464,0.00021218127,0.2300045,0.00021218127,0.090554826,0.00021218127,0.095471226,0.00021218127,0.103244305,0.00021218127,0.08181399,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127},
{0.00024024375,0.34372437,0.00024024375,0.17840736,0.00024024375,0.11779562,0.00024024375,0.108812846,0.00024024375,0.12948553,0.00024024375,0.10784015,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375},
{0.24590501,0.00017202317,0.00017202317,0.33208862,0.112247206,0.00017202317,0.00017202317,0.101464294,0.10599144,0.00017202317,0.00017202317,0.09232609,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317},
{0.18598366,0.11921695,0.00010288789,0.14730032,0.08417484,0.07907561,0.00010288789,0.08127892,0.086749546,0.11186423,0.00010288789,0.09869709,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789},
{0.34792632,0.27844614,0.00014653742,0.00014653742,0.09708283,0.079991564,0.00014653742,0.00014653742,0.105896525,0.08215746,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742},
{0.000333667,0.26445144,0.24113545,0.000333667,0.000333667,0.13884616,0.10018148,0.000333667,0.000333667,0.14495796,0.09107482,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667},
{0.25093722,0.0002789552,0.25111413,0.0002789552,0.14066146,0.0002789552,0.08996645,0.0002789552,0.16742076,0.0002789552,0.08372058,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552},
{0.28679758,0.23526531,0.00020699753,0.00020699753,0.1155854,0.11367698,0.00020699753,0.00020699753,0.12025042,0.116418436,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753},
{0.207951,0.16726714,0.14668314,0.000115403236,0.082687825,0.07389747,0.057985906,0.000115403236,0.112715185,0.086256884,0.058208264,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236}

}};

static constexpr const double transProbs[CONTEXT_NUMBER][4] = {
 {0.88379735,0.008936321,0.031840708,0.07542565}, // AA
{0.8627407,0.06848316,0.016524542,0.052251622}, // AC
{0.8260586,0.062281117,0.019626869,0.09203338}, // AG
{0.85028476,0.08471006,0.020964688,0.044040497}, // AT
{0.8477463,0.07076558,0.012422741,0.06906539}, // CA
{0.88682485,0.004445134,0.02852631,0.08020369}, // CC
{0.8456544,0.049489412,0.020910103,0.08394608}, // CG
{0.8811395,0.063487604,0.020578036,0.03479482}, // CT
{0.8321299,0.07805726,0.015899435,0.07391341}, // GA
{0.89367783,0.04156596,0.016215071,0.048541132}, // GC
{0.8230745,0.0058618053,0.039204277,0.13185942}, // GG
{0.8597766,0.07677287,0.027181951,0.03626856}, // GT
{0.8221027,0.11469461,0.013910681,0.04929198}, // TA
{0.8874163,0.06608134,0.013853184,0.03264917}, // TC
{0.8457249,0.079008035,0.015319524,0.059947558}, // TG
{0.937836,0.007597815,0.028035833,0.02653034}, // TT
    };

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

Kit__500_Chem__1_BC__1_PW3_v2_Model::Kit__500_Chem__1_BC__1_PW3_v2_Model(const NucleotideLevelFeats& feats){
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)
        double sum = 1.0;

        // cached transitions
        for (size_t j = 0; j < 4; ++j) {
            double xb = transProbs[ctx][j];
            ctxTrans_[ctx][j] = xb;
            sum += xb;
        }
        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] /= sum;

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> Kit__500_Chem__1_BC__1_PW3_v2_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<Kit__500_Chem__1_BC__1_PW3_v2_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> Kit__500_Chem__1_BC__1_PW3_v2_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double Kit__500_Chem__1_BC__1_PW3_v2_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

Kit__500_Chem__1_BC__1_PW3_v2_Recursor::Kit__500_Chem__1_BC__1_PW3_v2_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<Kit__500_Chem__1_BC__1_PW3_v2_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> Kit__500_Chem__1_BC__1_PW3_v2_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {18, 46};
    std::vector<uint8_t> cr_boundaries = {255};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double Kit__500_Chem__1_BC__1_PW3_v2_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double Kit__500_Chem__1_BC__1_PW3_v2_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> Kit__500_Chem__1_BC__1_PW3_v2_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }


    Data::NucleotideLevelFeats feats;

    const Kit__500_Chem__1_BC__1_PW3_v2_Model model{feats};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData Kit__500_Chem__1_BC__1_PW3_v2_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> Kit__500_Chem__1_BC__1_PW3_v2_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, Kit__500_Chem__1_BC__1_PW3_v2_InitialiseModel,
                            Kit__500_Chem__1_BC__1_PW3_v2_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(Kit__500_Chem__1_BC__1_PW3_v2)

}  // namespace Consensus
}  // namespace PacBio
