// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace S_P2C2v6 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class S_P2C2v6_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"S/P2-C2/6.0"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    S_P2C2v6_Model(const SNR& snr);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    SNR snr_;
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class S_P2C2v6_Recursor : public Recursor<S_P2C2v6_Recursor>
{
public:
    S_P2C2v6_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
		// match

		{0.0018242961,0.000018190985,0.00034222353,0.000086832835,0.00036265477,0.000010842903,0.00009274715,0.00001514422,0.00014266034,0.000007706526,0.00003476898,0.000008602634,0.00013316161,0.000015413052,0.00004883787,0.000014337723,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000036740416,0.0000037636523,0.0000036740416,0.0007787176,0.0000141585015,0.00007715487,0.0000499132,0.021852482,0.0009527417,0.00032259876,0.00056221796,0.023986652,0.00068355096,0.00034320925,0.0005356932,0.9191102,0.009311634,0.006113874,0.01202917},
{0.00011642023,0.00016203654,0.00024154586,0.000052696694,0.000027276923,0.000083687926,0.00006244674,0.000012883994,0.000014741146,0.000056759214,0.000030410869,0.000009517906,0.00002124118,0.00009726835,0.000042366286,0.000014741146,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.000004758953,0.00008008969,0.000098313,0.000054321703,0.00005165205,0.0009817372,0.0119394,0.0002380637,0.0003346356,0.0009227725,0.014003624,0.00026151026,0.00033335882,0.027973704,0.92938757,0.00509974,0.0070411605},
{0.00011417996,0.000019554958,0.019018576,0.00009895596,0.00002677323,0.000010499306,0.007016949,0.000016142683,0.000014961512,0.000010499306,0.0029462366,0.000011286755,0.000020473648,0.000012992891,0.0034852447,0.000014042822,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000053808944,0.0000056433773,0.0000053808944,0.00008556934,0.000016798891,0.0027417627,0.00005420267,0.0011259194,0.0006642124,0.027356599,0.0006331082,0.0011063644,0.00048060576,0.033276632,0.00049661717,0.035120703,0.0077351015,0.84778935,0.008306658},
{0.00008858166,0.000016174954,0.00023558346,0.003330328,0.000022740083,0.000006755422,0.000062701736,0.00037402203,0.000013510844,0.0000073263027,0.00002549934,0.00011769658,0.000018363331,0.000009514679,0.000040247094,0.000082968,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.0000039010183,0.00006203571,0.000012654523,0.000064224085,0.0006959036,0.0008708786,0.00044119568,0.0002072297,0.02477965,0.00084880454,0.00032016894,0.00022245319,0.02665699,0.025610281,0.00528902,0.004878652,0.904463},
{0.0009868171,0.000019485282,0.00028544065,0.00005161726,0.000201223,0.000010117357,0.0000812199,0.000011709904,0.00009349188,0.0000060891502,0.00003306877,0.000008150094,0.00012009678,0.0000116162255,0.000051991978,0.000010304716,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.000003840849,0.0000039345277,0.000003840849,0.0005856826,0.000020141037,0.00005517707,0.000044497636,0.015982615,0.0005852142,0.0002418798,0.0003789325,0.017733011,0.00043420328,0.00025246554,0.00036385015,0.9318908,0.016839031,0.0043835323,0.008103535},
{0.00015135006,0.00021606915,0.0004699758,0.00007081827,0.000022250717,0.00007849873,0.00014570267,0.0000126501545,0.000012988998,0.000052633677,0.00006697805,0.000009713512,0.000021798927,0.00008561444,0.000100523546,0.0000141184755,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00006404141,0.00014299192,0.000082564846,0.00006155655,0.0010643072,0.0091914665,0.00044241655,0.00043552674,0.0008274556,0.009886434,0.00050453783,0.00041124297,0.017550508,0.9348641,0.01205458,0.010736367},
{0.00015564558,0.000025347994,0.012913158,0.00006136883,0.000023747069,0.000012362706,0.00513915,0.000010139198,0.000011295422,0.000007826749,0.0023807548,0.0000066705247,0.0000160982,0.000011918005,0.0037970406,0.000008982974,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000039133747,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.0000036465535,0.000003735494,0.0000036465535,0.00006714995,0.00002410283,0.002025883,0.00004527063,0.0012764717,0.0006981816,0.018182784,0.00042175504,0.0008410198,0.00055863423,0.022306325,0.00036856873,0.008328462,0.020644119,0.892396,0.0071167387},
{0.0000715298,0.000016290178,0.0002378611,0.0018017181,0.000014330457,0.000009431155,0.0000694476,0.00018886807,0.000010533498,0.0000069815046,0.000027068641,0.00006883519,0.0000127381845,0.000010533498,0.000050830255,0.00006344596,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000005021784,0.000031355532,0.000017515003,0.000058546655,0.00049139996,0.0006053087,0.00043995728,0.0001957271,0.0155216,0.0004488985,0.00031796467,0.0002194887,0.016715191,0.009350929,0.009789295,0.006186103,0.9367896},
{0.0010737437,0.000018642173,0.00054835266,0.000041717543,0.00023620996,0.000011821865,0.00016846159,0.000009207414,0.00013686082,0.000008525384,0.00007081752,0.000009889445,0.00017766899,0.000018642173,0.00012390224,0.000015573034,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0000046605433,0.0010192948,0.000016709751,0.0001224245,0.000044445667,0.018450635,0.0006588416,0.0005471023,0.00039091727,0.020287003,0.00046685,0.00063497055,0.00037398018,0.91883117,0.006127705,0.020717818,0.0084909415},
{0.00005541006,0.00017846657,0.0004432035,0.000037017,0.00001308293,0.000076727534,0.00013960256,0.0000085423835,0.0000079267165,0.00005233172,0.00006780036,0.000007234091,0.000029167239,0.00013683205,0.00012505743,0.000016930851,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.0000032322532,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000003155295,0.000050176885,0.0001271353,0.000108434404,0.000052562595,0.00047198596,0.0076717534,0.00047106243,0.00039841371,0.0004038008,0.009036149,0.0005553319,0.00039502754,0.008746709,0.9449189,0.017668959,0.0074272566},
{0.00013724371,0.000028627523,0.0145536065,0.0000701254,0.000028266672,0.000015396314,0.004946547,0.000015636882,0.000017320854,0.000014073194,0.0020765779,0.000012870357,0.000027665252,0.000019967096,0.0028491602,0.000015396314,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.0000050519157,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.0000054127668,0.000004931632,0.00010163973,0.00002754497,0.0023440889,0.00008215377,0.0012271344,0.0009947462,0.017634794,0.0008652007,0.0010106236,0.0007485255,0.0213939,0.00074431556,0.018776046,0.016086983,0.87169135,0.021284081},
{0.000063514344,0.000013455462,0.00042042616,0.0009098401,0.00002075334,0.0000075259363,0.00012930926,0.00015770257,0.000014367696,0.000007297878,0.00006168987,0.00008027665,0.00002075334,0.000011630992,0.00010023179,0.0000722946,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000004675203,0.000042761003,0.0000123151685,0.00010251237,0.00055053364,0.00072933163,0.0004298906,0.00039055047,0.016593207,0.0006277315,0.00029476584,0.00046432746,0.017762806,0.016749313,0.0058149262,0.01590082,0.92129356},
{0.0006886563,0.000013081094,0.00020690633,0.000055700144,0.00018608912,0.000009424014,0.000054856202,0.000015894233,0.00009424014,0.000008298759,0.000022505108,0.000011393211,0.00013348342,0.000012237153,0.000029115983,0.000017160146,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005766934,0.000005907591,0.000005766934,0.000005766934,0.000005766934,0.0005963854,0.000010830583,0.00005401226,0.000054293574,0.009491248,0.00036261356,0.00016063021,0.0004951124,0.01065223,0.0002602153,0.00016864766,0.0005309799,0.945516,0.004258951,0.0023889171,0.02325523},
{0.00005178504,0.000119462355,0.00013989527,0.0000433524,0.000014486837,0.000056866244,0.00004010908,0.000010594851,0.000011459737,0.000034811655,0.000018162602,0.0000088650795,0.000021946478,0.0000695152,0.000029298008,0.000016649052,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.0000044325398,0.000032216998,0.00008205604,0.000039136085,0.00005502836,0.0002672497,0.0048127654,0.00013784117,0.00035006253,0.00023405973,0.0053972118,0.00014940902,0.00040833422,0.005699922,0.962038,0.002862664,0.016604943},
{0.00007041946,0.000013713264,0.0086207315,0.000074311065,0.000018716752,0.000006763975,0.0031395035,0.000015381092,0.000011118862,0.0000071346035,0.0013634505,0.000009265718,0.000020940524,0.00000889509,0.001991203,0.000010192291,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000037989446,0.0000041695735,0.0000037989446,0.000044568107,0.000010655576,0.0017491824,0.00005374117,0.0003711847,0.0003306935,0.011557038,0.00055344135,0.00031948197,0.00024517093,0.014493344,0.0005499204,0.0063677724,0.004152895,0.9209502,0.022747062},
{0.000042968637,0.000009153082,0.00017984111,0.0012312591,0.0000138991245,0.00000559355,0.000048562186,0.00018484141,0.000009237833,0.0000055087994,0.000020679186,0.000072885654,0.000013136368,0.0000059325534,0.000033815555,0.00007441117,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.000030171272,0.000008475076,0.000053562482,0.00046519694,0.0003461221,0.00024611622,0.00015246661,0.011152692,0.00031925613,0.00018882469,0.00017433232,0.012403104,0.011391265,0.005055383,0.004589847,0.9513603}
},

{ // branch
  


	{0.0026161014,0.0008020165,0.0027115797,0.0009738772,0.0012030248,0.00084020774,0.0015467461,0.00078292086,0.00093568594,0.00078292086,0.00093568594,0.00084020774,0.0010120685,0.00082111213,0.0011648334,0.00082111213,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.00078292086,0.0022150932,0.00082111213,0.0014703636,0.001451268,0.020470517,0.0024633363,0.0025015275,0.0025206234,0.021711733,0.0019477544,0.0030362054,0.0030362054,0.73617476,0.032882676,0.053085852,0.0703674},
{0.0034086904,0.000092615184,0.00023492631,0.00011972206,0.00073188584,0.000092615184,0.00012875769,0.0000993919,0.0003275415,0.000092615184,0.00010165081,0.000094874085,0.00050373626,0.000092615184,0.00011972206,0.000094874085,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.000092615184,0.0024305838,0.000092615184,0.0001626413,0.00011972206,0.02227508,0.000092615184,0.00025073867,0.00025299756,0.02365979,0.000092615184,0.0002304085,0.00031398804,0.9325739,0.000092615184,0.0032596027,0.004800177},
{0.0029199906,0.00011830533,0.00011023906,0.00014250414,0.0005861491,0.00011292782,0.00011023906,0.00011023906,0.00026618698,0.00011292782,0.00011023906,0.00011830533,0.00036567103,0.00011830533,0.00011023906,0.00012368284,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.00011023906,0.0021483172,0.0001263716,0.00011023906,0.00016132546,0.025712589,0.00023929942,0.00011023906,0.00031727337,0.02646544,0.00022854439,0.00011023906,0.00030651834,0.9271454,0.0034765634,0.00011023906,0.004167574},
{0.0030862773,0.0000764018,0.0002558572,0.00007284823,0.0007195983,0.00007462501,0.00013503573,0.00007284823,0.00032870538,0.00007284823,0.00009239287,0.00007284823,0.00038200896,0.00007462501,0.000115491086,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.00007284823,0.002300938,0.00007284823,0.00015991073,0.00007284823,0.032927398,0.00019722324,0.00027007147,0.00007284823,0.031457994,0.00016879466,0.00025763395,0.00007284823,0.9172604,0.0030489648,0.0035500184,0.00007284823},
{0.00018056743,0.0011318495,0.00044921652,0.000211396,0.00018056743,0.0005064696,0.00025103276,0.00019818376,0.00018056743,0.000317094,0.000211396,0.0001849715,0.00018056743,0.0005152778,0.00024222459,0.000211396,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.00018056743,0.0012727801,0.00028186134,0.000317094,0.00018056743,0.03385419,0.00041838794,0.00062537985,0.00018056743,0.023883345,0.00046683283,0.00068263296,0.00018056743,0.9104782,0.0050691003,0.010996996},
{0.0019862538,0.0021438932,0.0043823696,0.0016079198,0.0015448641,0.0015448641,0.0019231982,0.0014818085,0.0015448641,0.001576392,0.0016709755,0.0014502805,0.0015448641,0.0015133363,0.0023961158,0.0014502805,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0012926414,0.0021123653,0.0022069488,0.0030897283,0.0023015323,0.007377514,0.009679046,0.0051705656,0.005801122,0.008260294,0.009143073,0.005139038,0.0055488995,0.18932468,0.4631124,0.09127309,0.11933287},
{0.00034447454,0.0012104452,0.0001961591,0.00028227773,0.00022008095,0.0005406336,0.0001961591,0.00022008095,0.00021051221,0.00040667132,0.0001961591,0.00021529659,0.00026314027,0.00060283043,0.0001961591,0.00023921843,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0001961591,0.0003205527,0.0013013482,0.0001961591,0.0003779651,0.0013491919,0.034074273,0.0001961591,0.0008468332,0.0012295827,0.025701627,0.0001961591,0.0008898925,0.017472513,0.8899069,0.0001961591,0.013927297},
{0.00036648693,0.0012858101,0.0005155664,0.00025467738,0.00026710067,0.0005714712,0.00034164038,0.00025467738,0.0002733123,0.00048450817,0.0003043705,0.00025467738,0.00031058217,0.0007205506,0.0003292171,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.00025467738,0.0004161801,0.0017268368,0.000347852,0.00025467738,0.0011926355,0.04970557,0.00062737596,0.00025467738,0.0010311328,0.033971477,0.00070812734,0.00025467738,0.014603573,0.8724936,0.0072179292,0.00025467738},
{0.00013295974,0.00014268851,0.020881167,0.00018484647,0.00013295974,0.00013944559,0.0064112544,0.00013944559,0.00013295974,0.00013295974,0.002740268,0.00013295974,0.00013295974,0.00013295974,0.0046762917,0.00014268851,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013295974,0.00013620267,0.0046017044,0.00018484647,0.00013295974,0.00032104916,0.021500565,0.00040536508,0.00013295974,0.0002497049,0.025865536,0.00030483454,0.00013295974,0.0036645003,0.8962914,0.0052989325},
{0.0001967882,0.000113638256,0.022749824,0.0001413549,0.00012749658,0.000113638256,0.006929162,0.00013026824,0.00012472492,0.000113638256,0.0030294296,0.00012195325,0.00014689824,0.000113638256,0.005185785,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.000113638256,0.00022173318,0.000113638256,0.005934134,0.00022173318,0.0008647594,0.000113638256,0.024349075,0.000496128,0.0008564444,0.000113638256,0.028218318,0.00048504132,0.015471432,0.000113638256,0.87123954,0.008098804},
{0.0018818841,0.0013283888,0.012398295,0.0019372336,0.0012730393,0.0011346655,0.0050644823,0.001190015,0.0012176897,0.0011623402,0.0025460785,0.001190015,0.0012176897,0.0011623402,0.0038191178,0.0012453644,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.0011346655,0.00238003,0.0012453644,0.0035977196,0.002241656,0.008440804,0.004040516,0.015691593,0.0053965794,0.0088836,0.0033486467,0.015912991,0.005756351,0.15326285,0.07187137,0.47761112,0.14424089},
{0.00021019157,0.00014238784,0.025219599,0.00013899765,0.0001559486,0.00013899765,0.007824551,0.00013899765,0.00014238784,0.00014238784,0.0031325326,0.00013899765,0.00015255841,0.00014238784,0.0055022733,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00013899765,0.00024409345,0.00014577803,0.0056311004,0.00013899765,0.00085771724,0.00040682242,0.022402354,0.00013899765,0.00091196026,0.00041360277,0.027745288,0.00013899765,0.013089512,0.0052378387,0.8744478,0.00013899765},
{0.00012250435,0.00012549225,0.0002509845,0.001476028,0.00012250435,0.00012250435,0.00014043182,0.0003555614,0.00012250435,0.00012250435,0.00013445599,0.0002718999,0.00012250435,0.00012250435,0.00015835928,0.00031074273,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00012250435,0.00017329883,0.0016164598,0.00012250435,0.00017628675,0.00025994825,0.015985323,0.00012250435,0.00018525048,0.0002748878,0.017222319,0.00012250435,0.0018704323,0.0028654065,0.95075625},
{0.00019029989,0.0001182166,0.00023354987,0.0022634154,0.00013839992,0.0001182166,0.00017876657,0.000573783,0.00012398326,0.0001182166,0.00013839992,0.00031428316,0.00012974993,0.0001182166,0.00015569992,0.0003344665,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001182166,0.0001729999,0.0001182166,0.0002075999,0.0026440152,0.00058531633,0.0001182166,0.00029986651,0.017605623,0.0006919996,0.0001182166,0.0003085165,0.018885823,0.015731458,0.0001182166,0.0034369314,0.9299264},
{0.000160898,0.00010647662,0.00009701203,0.0034853346,0.00009937818,0.00009937818,0.00009701203,0.00054657995,0.00009937818,0.00009937818,0.00009701203,0.0003170637,0.00010647662,0.00009701203,0.00009701203,0.00033835904,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00009701203,0.00014906726,0.00010174432,0.00009701203,0.002314092,0.00068618264,0.00018692562,0.00009701203,0.021472784,0.00065542274,0.00018455947,0.00009701203,0.021557966,0.013169974,0.0028370104,0.00009701203,0.92724806},
{0.0011536138,0.00084232114,0.0018494442,0.0022889161,0.00086063246,0.0007507645,0.0012634817,0.00089725514,0.00086063246,0.0007507645,0.00095218915,0.00091556646,0.00084232114,0.0007690758,0.0011536138,0.0010254345,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0007507645,0.0010254345,0.00078738714,0.0013367271,0.002948124,0.004614455,0.0014282836,0.0019410009,0.014081412,0.004724323,0.0017212649,0.002398784,0.015802678,0.0897072,0.018787423,0.028455805,0.7690392}
},


    {// stickPmf

    {0.0005772956,0.0008552527,0.012508071,0.0012914316,0.00020526066,0.00042762636,0.0029463458,0.00032713418,0.0001475311,0.00030575285,0.0011118286,0.00020953693,0.00022450385,0.00039983066,0.0014026145,0.0002950622,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.00008766341,0.0004939085,0.00055377616,0.0031729876,0.0018623129,0.0040667267,0.04651292,0.012249357,0.011374862,0.004150114,0.03220882,0.012576492,0.010605134,0.14469166,0.27361247,0.18388362,0.23194455},
{0.0005739467,0.00048882747,0.009944356,0.0017048162,0.00024076577,0.00022130997,0.002390634,0.00035506874,0.00015078261,0.00019212623,0.0009338794,0.00026265357,0.00025535765,0.0002723815,0.00130354,0.00032345302,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.00010214306,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.000099711084,0.0004669397,0.0004985554,0.0026678795,0.002266603,0.003360993,0.016488807,0.009915173,0.01174402,0.0035336635,0.014370556,0.010467231,0.0116151245,0.12016888,0.4422989,0.1360351,0.19129449},
{0.00044519472,0.000514676,0.014714587,0.004593483,0.00019815026,0.00027020488,0.0044570942,0.0005275429,0.00015954956,0.00021359054,0.0018090861,0.0002547646,0.00021359054,0.0003190991,0.0024910318,0.00036284656,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.000105508574,0.00038858037,0.00041431416,0.003162684,0.0020638506,0.0028796121,0.01949078,0.015532921,0.03151104,0.0029207862,0.013440764,0.017388329,0.022501634,0.09451767,0.19001837,0.37576237,0.17308554},
{0.00041961274,0.0003634862,0.009398524,0.0033341842,0.00015100713,0.00017773407,0.0018695486,0.0004957845,0.000096216936,0.00016971599,0.00070826354,0.00020045195,0.00015234348,0.0002512331,0.0010450229,0.00026726926,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.000054790202,0.0003113687,0.00037284064,0.0027956367,0.0018160947,0.002469568,0.022814104,0.007316496,0.01763309,0.0024521956,0.015660644,0.007820299,0.018110165,0.06968378,0.17034808,0.100375645,0.53916633},
{0.0016767039,0.00011145719,0.008160605,0.0005972652,0.00038161973,0.00006663202,0.0019989605,0.00015749387,0.00019747307,0.00006178605,0.0007293177,0.00011145719,0.0003198337,0.00006663202,0.0009958458,0.0001514364,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.00004967114,0.0016779153,0.000083592895,0.001312045,0.0010394595,0.01774229,0.0009280023,0.0061422605,0.0045418805,0.01888836,0.000826237,0.0054929014,0.0046787793,0.72755986,0.042478517,0.06979038,0.07944354},
{0.0031652367,0.0002808404,0.013017779,0.002051787,0.0007764411,0.00018832827,0.003565021,0.0003469205,0.00049890473,0.00015528823,0.0017015624,0.0002676244,0.0010044174,0.00020154429,0.0022863713,0.00038326456,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0001354642,0.0018105946,0.00025110436,0.0032114927,0.0029802122,0.023131337,0.0018931947,0.013212715,0.012988043,0.017692946,0.0018403307,0.013397739,0.012710506,0.2961941,0.09249231,0.23994014,0.23202704},
{0.007339853,0.00012840987,0.01427262,0.0019657637,0.0006857633,0.00007513343,0.0049997885,0.00024998942,0.0002868731,0.000064204934,0.002274494,0.00015026686,0.00044533634,0.0000833298,0.0036829042,0.00017348993,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000056008557,0.000058740683,0.000056008557,0.0023482612,0.00011474924,0.0026337681,0.0016461052,0.059076734,0.0009794667,0.013537678,0.013735757,0.03439745,0.000963074,0.015569013,0.0098370155,0.14258276,0.045170218,0.5231131,0.09562163},
{0.004480396,0.0001187923,0.009224062,0.0023822673,0.000719175,0.00007544916,0.0021703674,0.000383667,0.0003467451,0.00007544916,0.0009198377,0.00020387328,0.00056667137,0.00008989687,0.0013645062,0.00021511038,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.00006581735,0.0015796166,0.00009631808,0.0021238136,0.0014736666,0.033868648,0.00093749596,0.0067085545,0.01339303,0.02082076,0.000820309,0.0066347104,0.01374138,0.113740414,0.035006806,0.09537256,0.6282395},
{0.0021713385,0.00064212485,0.0011320531,0.0004189031,0.0005044231,0.00025366104,0.00037541837,0.00013045425,0.0002797519,0.00018408545,0.00018988342,0.00012030781,0.0004739838,0.00024351462,0.00025800953,0.00018843393,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.00005942916,0.0027192465,0.00035512546,0.00033918108,0.00079577096,0.0192478,0.01993341,0.0013349819,0.005202226,0.020285636,0.014349968,0.0015625521,0.00459054,0.66227275,0.10881479,0.04469653,0.08403138},
{0.0024626069,0.0008958687,0.0017215541,0.0015605454,0.00054082397,0.00044587013,0.0006006861,0.0003509163,0.00044999857,0.0003199531,0.00032408154,0.00029931095,0.0014346284,0.00066054834,0.00049747544,0.0003818795,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008463275,0.00008669697,0.00008463275,0.00008463275,0.00008463275,0.002010544,0.0010651342,0.00065022724,0.0035050346,0.015060502,0.014455687,0.0022190295,0.021556582,0.0133492695,0.012936426,0.0025926523,0.020594658,0.1807797,0.4231679,0.06610231,0.20429727},
{0.003061744,0.0005515382,0.0022438648,0.0019044566,0.00050439814,0.00024277107,0.0007683823,0.0003299801,0.0002946251,0.00018620306,0.00037240612,0.0002828401,0.00048318517,0.0003559071,0.0006198912,0.00035119313,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.00009663703,0.0019987368,0.00042897413,0.0006481752,0.0021000877,0.0336509,0.016902052,0.002722336,0.025271762,0.023603005,0.012421394,0.003005176,0.01725796,0.25777575,0.2542874,0.08497223,0.2473083},
{0.0030040478,0.0003492173,0.000928217,0.0011060712,0.0006776633,0.00019083623,0.00030897293,0.00026353574,0.0003686904,0.00018045059,0.00015708288,0.00016876672,0.00054784276,0.00027262318,0.00024276445,0.00020901111,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.00005322643,0.0014942347,0.00028560523,0.00037777785,0.0012203133,0.029334255,0.021796873,0.0011696833,0.012592594,0.020667434,0.01611203,0.0013241697,0.013024897,0.13867302,0.11895588,0.03473479,0.5775574},
{0.0016770503,0.00023647431,0.004585045,0.00020196184,0.0005202435,0.00012782395,0.0010455999,0.000094589726,0.00026331734,0.000117598036,0.0003885848,0.000067746696,0.00045377502,0.00015722346,0.0005585907,0.00008052909,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.00005240782,0.0020426267,0.00015594522,0.0011862062,0.00019940536,0.01411432,0.007996666,0.0038347186,0.0014392977,0.015398951,0.0056268102,0.0038129885,0.001393281,0.75739527,0.07116343,0.05137117,0.050615728},
{0.0019699903,0.0006736227,0.0084029855,0.0003093373,0.00071432494,0.00031137242,0.0020127275,0.00013024728,0.0003846365,0.00023403809,0.00083032646,0.00010786104,0.0009442928,0.00041312812,0.0010745401,0.00013635262,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.00008343967,0.000085474785,0.00008343967,0.0012800866,0.0006023937,0.0025052251,0.00034800448,0.008921939,0.013484664,0.0073325154,0.0019333581,0.007849434,0.011447515,0.008073296,0.0020819216,0.13370699,0.6164319,0.09442522,0.06825365},
{0.0020214408,0.00029768227,0.014471938,0.00023407495,0.00053811795,0.00015392972,0.0044436078,0.000101771715,0.000251885,0.00012212606,0.0018954983,0.00008396167,0.0004439791,0.00017682835,0.0030595122,0.000081417376,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.000052158004,0.0011156724,0.00024552428,0.003186727,0.0002467964,0.012257132,0.010815789,0.013557265,0.0015850945,0.008950823,0.007886036,0.0156168705,0.0014566077,0.09867913,0.096251875,0.6497959,0.048305947},
{0.00541004,0.0004838451,0.01653597,0.0005640681,0.0015919255,0.00023816209,0.003351818,0.00019554362,0.0008022302,0.0002607248,0.0012835683,0.00014289726,0.0014214517,0.00042367782,0.0020983333,0.00019805058,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.00010278574,0.0028529312,0.00053649145,0.004918674,0.00053649145,0.03696777,0.029572211,0.012218969,0.0028078058,0.026548807,0.020700047,0.013028719,0.0030083633,0.27081037,0.23723452,0.17666864,0.123297766}
    
    }};

static constexpr const double transProbs[CONTEXT_NUMBER][4] = {
 {0.88376147,0.0039436133,0.0368431,0.07545185}, // AA
{0.86271465,0.044084422,0.040928762,0.05227218}, // AC
{0.8260334,0.040053193,0.041861534,0.09205187}, // AG
{0.8502619,0.045333657,0.060343836,0.04406055}, // AT
{0.847724,0.01783112,0.065361425,0.06908343}, // CA
{0.8867849,0.002919025,0.030064907,0.08023116}, // CC
{0.84563303,0.015529425,0.054875035,0.08396253}, // CG
{0.88111424,0.017100655,0.06697037,0.03481471}, // CT
{0.832106,0.028931394,0.065030046,0.073932536}, // GA
{0.89365226,0.024640523,0.033146262,0.048560973}, // GC
{0.82303166,0.0033224907,0.041758653,0.13188717}, // GG
{0.85975313,0.028673114,0.07528632,0.036287446}, // GT
{0.82208014,0.038414985,0.09019544,0.049309444}, // TA
{0.8873922,0.033034254,0.046905957,0.032667577}, // TC
{0.84570134,0.032922734,0.061409213,0.059966724}, // TG
{0.93780816,0.004136089,0.0315052,0.026550528}// TT
    };

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

S_P2C2v6_Model::S_P2C2v6_Model(const SNR& snr)
    : snr_(ClampSNR(snr, SNR{snrRanges[0]}, SNR{snrRanges[1]}))
{
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)
        const double snr1 = snr_[bp], snr2 = snr1 * snr1, snr3 = snr2 * snr1;
        double sum = 1.0;

        // cached transitions
        for (size_t j = 0; j < 4; ++j) {
            double xb = transProbs[ctx][j];
            ctxTrans_[ctx][j] = xb;
            sum += xb;
        }
        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] /= sum;

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> S_P2C2v6_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<S_P2C2v6_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> S_P2C2v6_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double S_P2C2v6_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

S_P2C2v6_Recursor::S_P2C2v6_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<S_P2C2v6_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> S_P2C2v6_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {3, 4, 5};
    std::vector<uint8_t> cr_boundaries = {43, 110, 117};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double S_P2C2v6_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double S_P2C2v6_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> S_P2C2v6_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }

    const S_P2C2v6_Model model{snrs};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData S_P2C2v6_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> S_P2C2v6_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, S_P2C2v6_InitialiseModel,
                            S_P2C2v6_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(S_P2C2v6)

}  // namespace Consensus
}  // namespace PacBio
