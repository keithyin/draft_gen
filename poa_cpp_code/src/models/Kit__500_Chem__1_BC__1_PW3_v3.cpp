// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace Kit__500_Chem__1_BC__1_PW3_v3 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class Kit__500_Chem__1_BC__1_PW3_v3_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"Kit__500_Chem__1_BC__1_PW3_v3"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    Kit__500_Chem__1_BC__1_PW3_v3_Model(const NucleotideLevelFeats& feats);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class Kit__500_Chem__1_BC__1_PW3_v3_Recursor : public Recursor<Kit__500_Chem__1_BC__1_PW3_v3_Recursor>
{
public:
    Kit__500_Chem__1_BC__1_PW3_v3_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
		// match

{0.3388957,0.0021675255,0.0025459318,0.0030886019,0.39754453,0.0011788765,0.0025731975,0.0023062949,0.24524817,0.0011321756,0.0019307303,0.0013881306,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332,0.0000000015648332},
{0.0042226934,0.28288528,0.0010704123,0.0017885858,0.004187308,0.38131437,0.0006024362,0.0012868082,0.0032962076,0.3178303,0.000584131,0.0009313519,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682,0.0000000030936682},
{0.0041516437,0.0012810898,0.30624777,0.002394616,0.004269474,0.00075725105,0.34105304,0.00087181776,0.0031828023,0.0007373662,0.33439413,0.00065891637,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903,0.0000000021964903},
{0.0053600986,0.0021180112,0.001680733,0.36891466,0.0053776475,0.002217298,0.0012114046,0.38391098,0.0039560017,0.0023669389,0.0013052678,0.22158086,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159,0.0000000021087159},
{0.32678932,0.002875949,0.002401398,0.0023094786,0.3877718,0.0033931704,0.002272349,0.0017137545,0.26259595,0.0046449685,0.0020411606,0.001190548,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987,0.0000000021907987},
{0.003955124,0.25352696,0.0012191808,0.0026795086,0.0018665865,0.33790407,0.0006186917,0.0020821516,0.001279738,0.39272758,0.00063179707,0.0015084367,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613,0.0000000028317613},
{0.0027894126,0.002798087,0.27626634,0.0025411993,0.0009183682,0.0029476732,0.34598005,0.0010186491,0.000614964,0.0035598646,0.3598761,0.00068852486,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557,0.000000016213557},
{0.0027013912,0.0038206838,0.001670927,0.322768,0.001460449,0.0041752523,0.0011530513,0.38608876,0.0012497718,0.004187438,0.0013587006,0.26936543,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605,0.000000002237605},
{0.30922794,0.0017325766,0.0042913808,0.0021675206,0.38175246,0.00084886624,0.0047459393,0.001602869,0.28603014,0.00083735364,0.0056106183,0.0011521789,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433,0.00000000266433},
{0.0020976604,0.23469083,0.002079332,0.0018530292,0.0008574569,0.32698986,0.0021339846,0.0011498884,0.00065809424,0.423912,0.002758401,0.00081931957,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686,0.0000000035762686},
{0.0024862862,0.0016842923,0.24564263,0.0028860932,0.0015995166,0.0011879542,0.3313814,0.0015306281,0.0011817425,0.0013532068,0.40797088,0.0010952208,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911,0.000000002829911},
{0.001798772,0.0021800373,0.0033320673,0.29326114,0.001530847,0.0021707916,0.0036114003,0.3785307,0.0014939458,0.0024447162,0.0037377574,0.3059077,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681,0.0000000031426681},
{0.25218916,0.0013987444,0.0015065707,0.004369578,0.35058415,0.000949728,0.001762661,0.0050888546,0.3724382,0.0009657851,0.003000338,0.0057461658,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685,0.0000000024574685},
{0.0015410128,0.21883005,0.0012092411,0.0035785735,0.00072923454,0.30208942,0.00057217426,0.0036710731,0.0005704371,0.46365473,0.00059314136,0.0029607236,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956,0.0000000025926956},
{0.0011267334,0.0010921315,0.18730743,0.0034776903,0.0006996696,0.00061605347,0.33233687,0.0032693315,0.0006023213,0.0007974142,0.46612164,0.0025525496,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706,0.0000000021191706},
{0.0019730597,0.0025276914,0.002173895,0.2672608,0.0019525257,0.002481994,0.0012529055,0.37519473,0.0020333547,0.0026728376,0.0017798635,0.3386963,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244,0.0000000015602244} 

		},

{ // branch
  
{0.18381187,0.09565483,0.087350026,0.107596785,0.19205968,0.028845062,0.043262467,0.056359343,0.11465838,0.023785895,0.029665638,0.036940984,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695,0.00000017377695},
{0.09353517,0.1968113,0.012101883,0.11602706,0.089806065,0.19075283,0.004961497,0.042406872,0.068056256,0.15981166,0.0037819531,0.021937897,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089,0.00000018350089},
{0.08517648,0.04150992,0.18224472,0.12564552,0.07860511,0.016518826,0.16931254,0.020981984,0.057411555,0.011031856,0.19830045,0.013255233,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305,0.000000111587305},
{0.05743836,0.011488239,0.014865634,0.31914216,0.05118744,0.0077821626,0.010114091,0.32134348,0.034343034,0.0071309493,0.01044165,0.15471971,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599,0.00000005912599},
{0.24258122,0.049030703,0.040682234,0.02826935,0.2695365,0.043256618,0.013262618,0.0114454655,0.22457235,0.0607747,0.009120538,0.0074642296,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304,0.0000000671304},
{0.27685535,0.115980424,0.017169707,0.17094289,0.05831209,0.10041501,0.007862105,0.06796092,0.03492433,0.09600758,0.008064689,0.045490965,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968,0.00000026867968},
{0.099855095,0.06386604,0.16129875,0.17317846,0.011314858,0.047023155,0.16548154,0.019685736,0.005901263,0.04459013,0.1945381,0.013232269,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059,0.0000006653059},
{0.06543702,0.055298988,0.026433464,0.27180412,0.013988103,0.039771486,0.015598552,0.28854525,0.010982257,0.03542144,0.015547165,0.16116872,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537,0.00000006554537},
{0.24675047,0.03316725,0.048130557,0.020181384,0.28518027,0.00755069,0.036503226,0.009719444,0.25761414,0.004975274,0.043993432,0.0062297173,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147,0.00000007958147},
{0.11234271,0.16424443,0.08202294,0.11660287,0.037105512,0.14731337,0.04844376,0.044742458,0.01271976,0.17413695,0.040793087,0.019525157,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778,0.00000013459778},
{0.15383303,0.09026816,0.12059259,0.19513677,0.056543592,0.030038018,0.1045604,0.048349503,0.03501713,0.026247839,0.10689376,0.03250368,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651,0.000000298651},
{0.039149012,0.02415502,0.04989554,0.2648906,0.017996121,0.0127183795,0.038521912,0.30296934,0.013591504,0.010264359,0.03521669,0.19062716,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807,0.0000000836807},
{0.18946952,0.015100356,0.019563753,0.053224277,0.25884414,0.006245464,0.00822033,0.055884752,0.32430315,0.0053284243,0.006071289,0.057741433,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114,0.000000060268114},
{0.04585904,0.18423119,0.012422602,0.08322773,0.022801321,0.17728409,0.0024641817,0.0774896,0.014931951,0.31322423,0.0021820895,0.06387494,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113,0.00000013523113},
{0.03772471,0.03648735,0.18073241,0.10329334,0.017949453,0.010355705,0.19212987,0.08711918,0.012634497,0.009845531,0.24743472,0.06428773,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147,0.00000010591147},
{0.07810023,0.06624666,0.090506434,0.1660419,0.05704794,0.040500898,0.034865588,0.1898908,0.055279125,0.037543245,0.040517755,0.14345206,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985,0.00000014162985} 

	},


    {// stickPmf

    {0.00000014015247,0.33391282,0.19297354,0.16224119,0.00000014015247,0.051888924,0.070383444,0.05896312,0.00000014015247,0.043489728,0.04880123,0.037338298,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247,0.00000014015247},
{0.00000012906484,0.23847713,0.10948378,0.103486,0.00000012906484,0.23560286,0.033012982,0.01789523,0.00000012906484,0.22702223,0.023876222,0.01113649,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484,0.00000012906484},
{0.00000007796705,0.076415196,0.17409457,0.24441352,0.00000007796705,0.016821625,0.16989535,0.01801647,0.00000007796705,0.012538271,0.2779092,0.009891524,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705,0.00000007796705},
{0.00000006328912,0.045290142,0.04328223,0.2722671,0.00000006328912,0.021487987,0.017234072,0.28393823,0.00000006328912,0.017657286,0.013931202,0.28490826,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912,0.00000006328912},
{0.34097463,0.00000005305159,0.08066648,0.04389324,0.2795822,0.00000005305159,0.011915547,0.012161229,0.21403998,0.00000005305159,0.009159463,0.007604309,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159,0.00000005305159},
{0.39501134,0.0000002545627,0.21219152,0.19914594,0.03532007,0.0000002545627,0.045909368,0.035042595,0.020512665,0.0000002545627,0.034379713,0.022472797,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627,0.0000002545627},
{0.23598856,0.00000045718446,0.16570605,0.18607864,0.015168923,0.00000045718446,0.15841441,0.012442275,0.009150547,0.00000045718446,0.21069711,0.006328347,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446,0.00000045718446},
{0.16659835,0.000000048438512,0.047247894,0.23510887,0.015897762,0.000000048438512,0.011015983,0.26304504,0.008950226,0.000000048438512,0.007559605,0.24457361,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512,0.000000048438512},
{0.27493167,0.15160911,0.00000009306688,0.05623836,0.24804446,0.019064844,0.00000009306688,0.018049484,0.20755339,0.0131845055,0.00000009306688,0.011319073,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688,0.00000009306688},
{0.16942324,0.20096627,0.0000001428081,0.16570881,0.0321501,0.16905451,0.0000001428081,0.029665954,0.013261732,0.20993862,0.0000001428081,0.0098229125,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081,0.0000001428081},
{0.21752103,0.1516568,0.00000023862555,0.44356674,0.043397397,0.030535242,0.00000023862555,0.040339887,0.028729085,0.022377111,0.00000023862555,0.021863589,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555,0.00000023862555},
{0.08888866,0.067656875,0.00000008193901,0.22658978,0.021302093,0.021923108,0.00000008193901,0.27149874,0.01149465,0.01517666,0.00000008193901,0.27546492,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901,0.00000008193901},
{0.23357105,0.061747428,0.059084024,0.00000005602925,0.26218596,0.014157696,0.014142511,0.00000005602925,0.33003822,0.012316238,0.012753771,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925,0.00000005602925},
{0.038423937,0.20834492,0.14442025,0.00000007285691,0.011652152,0.19449598,0.017899925,0.00000007285691,0.007282777,0.36580977,0.011666287,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691,0.00000007285691},
{0.059542008,0.11635822,0.2168309,0.000000068841935,0.015765699,0.017129594,0.21864742,0.000000068841935,0.009677524,0.012800125,0.33324474,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935,0.000000068841935},
{0.1758142,0.20048642,0.3076995,0.00000013362484,0.065926485,0.070943564,0.049875066,0.00000013362484,0.04095588,0.04902508,0.03926646,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484,0.00000013362484} 

}};

static constexpr const double transProbs[CONTEXT_NUMBER][4] = {
{0.967707,0.008713948,0.010804567,0.012774586}, // AA
{0.9217207,0.015539244,0.02209335,0.040646754}, // AC
{0.91264135,0.017964356,0.025710838,0.043683436}, // AG
{0.87438464,0.031184629,0.029133309,0.065297455}, // AT
{0.87305856,0.028492123,0.036053386,0.06239592}, // CA
{0.968495,0.0102073215,0.010773386,0.010524242}, // CC
{0.8949571,0.021809267,0.031737797,0.05149578}, // CG
{0.87075984,0.029726109,0.040224414,0.059289616}, // CT
{0.88286316,0.029557474,0.02527457,0.06230478}, // GA
{0.9109426,0.02420358,0.022812057,0.042041786}, // GC
{0.9694606,0.009186092,0.011496865,0.0098563805}, // GG
{0.8780547,0.032975584,0.03367652,0.055293173}, // GT
{0.8701701,0.035481576,0.038165927,0.056182384}, // TA
{0.911862,0.01748237,0.032449495,0.038206134}, // TC
{0.91800237,0.018368084,0.028258871,0.035370696}, // TG
{0.96606636,0.010642296,0.011279847,0.012011439}, // TT
    };

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

Kit__500_Chem__1_BC__1_PW3_v3_Model::Kit__500_Chem__1_BC__1_PW3_v3_Model(const NucleotideLevelFeats& feats){
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)
        double sum = 0.0;

        // cached transitions
        for (size_t j = 0; j < 4; ++j) {
            double xb = transProbs[ctx][j];
            ctxTrans_[ctx][j] = xb;
            sum += xb;
        }
        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] /= sum;

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> Kit__500_Chem__1_BC__1_PW3_v3_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<Kit__500_Chem__1_BC__1_PW3_v3_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> Kit__500_Chem__1_BC__1_PW3_v3_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double Kit__500_Chem__1_BC__1_PW3_v3_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

Kit__500_Chem__1_BC__1_PW3_v3_Recursor::Kit__500_Chem__1_BC__1_PW3_v3_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<Kit__500_Chem__1_BC__1_PW3_v3_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> Kit__500_Chem__1_BC__1_PW3_v3_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {18, 46};
    std::vector<uint8_t> cr_boundaries = {255};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double Kit__500_Chem__1_BC__1_PW3_v3_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double Kit__500_Chem__1_BC__1_PW3_v3_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> Kit__500_Chem__1_BC__1_PW3_v3_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }


    Data::NucleotideLevelFeats feats;

    const Kit__500_Chem__1_BC__1_PW3_v3_Model model{feats};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData Kit__500_Chem__1_BC__1_PW3_v3_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> Kit__500_Chem__1_BC__1_PW3_v3_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, Kit__500_Chem__1_BC__1_PW3_v3_InitialiseModel,
                            Kit__500_Chem__1_BC__1_PW3_v3_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(Kit__500_Chem__1_BC__1_PW3_v3)

}  // namespace Consensus
}  // namespace PacBio
