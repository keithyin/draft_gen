// Author: Lance Hepler

#include "../UnanimityInternalConfig.h"

#include <cassert>
#include <cmath>
#include <memory>
#include <random>
#include <stdexcept>

#include <pacbio/consensus/ModelConfig.h>
#include <pacbio/data/Read.h>
#include <pacbio/data/internal/BaseEncoding.h>

#include "../ModelFactory.h"
#include "../Recursor.h"
#include "../Simulator.h"
#include "CounterWeight.h"
#include "HelperFunctions.h"
#include <eigen3/Eigen/Dense>

using namespace Eigen;

using namespace PacBio::Data;

namespace PacBio {
namespace Consensus {
namespace Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1 {
namespace {

static constexpr const size_t CONTEXT_NUMBER = 16;
static constexpr const size_t OUTCOME_NUMBER = 64; // 4cr, 4pw, 4base

class Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model : public ModelConfig
{
public:
    static std::set<std::string> Chemistries() { return {"Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1"}; }
    static ModelForm Form() { return ModelForm::PWSNR; }
    Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model(const NucleotideLevelFeats& feats);
    std::unique_ptr<AbstractRecursor> CreateRecursor(const MappedRead& mr,
                                                     double scoreDiff) const override;
    std::vector<TemplatePosition> Populate(const std::string& tpl) const override;
    std::pair<Data::Read, std::vector<MoveType>> SimulateRead(
        std::default_random_engine* const rng, const std::string& tpl,
        const std::string& readname) const override;

    double ExpectedLLForEmission(MoveType move, const AlleleRep& prev, const AlleleRep& curr,
                                 MomentType moment) const override;

private:
    double ctxTrans_[CONTEXT_NUMBER][4];
    double cachedEmissionExpectations_[CONTEXT_NUMBER][3][2];
};

// TODO(lhepler) comments regarding the CRTP
class Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor : public Recursor<Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor>
{
public:
    Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight);
    static inline std::vector<uint8_t> EncodeRead(const MappedRead& read);
    inline double EmissionPr(MoveType move, uint8_t emission, const AlleleRep& prev,
                             const AlleleRep& curr) const;
    double UndoCounterWeights(size_t nEmissions) const override;

private:
    double counterWeight_;
    double nLgCounterWeight_;
};

static constexpr const double snrRanges[2][4] = {
    {3.91070819, 7.37540293, 3.84641552, 6.27542830},  // minimum
    {8.06702614, 15.2471046, 7.02776623, 11.3469543}   // maximum
};

static constexpr const double emissionPmf[3][CONTEXT_NUMBER][OUTCOME_NUMBER] = {
	{
		// match

{0.32939643,0.00511995,0.003728639,0.0056244037,0.33321488,0.0029411798,0.0020555658,0.00414915,0.30583322,0.0028402715,0.0015103404,0.0033966005,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943,0.000003641943},
{0.009813955,0.2534213,0.0027426877,0.0033454306,0.008809807,0.34054533,0.0016258134,0.0021349834,0.011316428,0.36208668,0.0016058527,0.0023057451,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562,0.000004730562},
{0.012473472,0.0035702572,0.42929038,0.004030346,0.011316705,0.002056852,0.31517398,0.0023284454,0.013343998,0.003191841,0.1998141,0.003133244,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975,0.0000053151975},
{0.009300954,0.0023736013,0.0023574645,0.36033168,0.0079249,0.0013863386,0.0013854894,0.34099534,0.0100693805,0.0022753656,0.0019286631,0.25946963,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278,0.0000038690278},
{0.25077775,0.0046748496,0.0027825013,0.0036631927,0.29763997,0.004735742,0.0014420255,0.002574343,0.41915634,0.008496363,0.0011412172,0.002715988,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905,0.000003840905},
{0.007507076,0.16880253,0.006006677,0.004352218,0.005581203,0.25485194,0.0041151405,0.0031954064,0.0066032675,0.5308402,0.003722308,0.0041812146,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086,0.00000463086},
{0.0057576983,0.005975693,0.3088681,0.003269212,0.0024264052,0.0059328233,0.30165416,0.0021168008,0.0025176588,0.01005596,0.34860054,0.002635328,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897,0.0000036465897},
{0.0037630883,0.0028654002,0.0025846658,0.2357347,0.0027301772,0.0025850332,0.0018481672,0.28614658,0.0040274095,0.005132586,0.002587238,0.44973382,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605,0.0000050218605},
{0.27644995,0.0033983784,0.008233246,0.0038908112,0.3027401,0.0017637557,0.0065968055,0.0027752211,0.38099873,0.0021424016,0.008080811,0.0026874652,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074,0.0000046606074},
{0.0035983857,0.169011,0.0070038345,0.0037008955,0.0024740875,0.2627832,0.005572084,0.001960615,0.0036901212,0.53038794,0.006987981,0.002665793,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311,0.0000031553311},
{0.008761706,0.0061317026,0.29026803,0.007679032,0.0057611084,0.004241925,0.2737431,0.006374676,0.006778468,0.007537578,0.3734548,0.009011415,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632,0.000004931632},
{0.005959931,0.0023007982,0.005846242,0.24682194,0.0048198514,0.0012779426,0.0047163116,0.2872748,0.0074655926,0.002989772,0.0069841547,0.42329955,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602,0.0000046752602},
{0.16259353,0.0020221071,0.0016208083,0.0066679176,0.23454992,0.0012459533,0.0006972443,0.0069507817,0.5701858,0.0016388125,0.00073873857,0.01078851,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995,0.0000057669995},
{0.002135965,0.10766023,0.001526755,0.0048903297,0.001578973,0.20847255,0.0008652188,0.004852815,0.002596089,0.65645546,0.0010024128,0.0077326973,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843,0.0000044325843},
{0.002881206,0.0018839262,0.21211006,0.0065877186,0.0018678963,0.0010789118,0.25079253,0.006831688,0.002456183,0.0017941404,0.500943,0.010575171,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855,0.0000037989855},
{0.003264006,0.0015228865,0.0018512108,0.18899369,0.0030910298,0.0011626957,0.0012123596,0.26190823,0.005793647,0.0028220308,0.002172162,0.52602535,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811,0.0000034747811}

		},

{ // branch
  
{0.32945517,0.0003551844,0.0003551844,0.0003551844,0.31554234,0.0003551844,0.0003551844,0.0003551844,0.33333623,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844,0.0003551844},
{0.22083373,0.09757665,0.00005974229,0.00005974229,0.21871217,0.09041923,0.00005974229,0.00005974229,0.27279058,0.096202575,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229,0.00005974229},
{0.2325229,0.00007106976,0.13970928,0.00007106976,0.21863484,0.00007106976,0.08757354,0.00007106976,0.25184867,0.00007106976,0.06558872,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976,0.00007106976},
{0.20030588,0.0000390692,0.0000390692,0.1542757,0.16855215,0.0000390692,0.0000390692,0.13088945,0.21476148,0.0000390692,0.0000390692,0.12894933,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692,0.0000390692},
{0.2079457,0.07176451,0.00004588881,0.00004588881,0.20787631,0.0717757,0.00004588881,0.00004588881,0.29387754,0.1440987,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881,0.00004588881},
{0.00087254465,0.23743854,0.00087254465,0.00087254465,0.00087254465,0.27265957,0.00087254465,0.00087254465,0.00087254465,0.43667668,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465,0.00087254465},
{0.000062078325,0.09610784,0.22845428,0.000062078325,0.000062078325,0.090585895,0.19226262,0.000062078325,0.000062078325,0.16706488,0.22192395,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325,0.000062078325},
{0.0000694107,0.089614294,0.0000694107,0.1777405,0.0000694107,0.070908956,0.0000694107,0.18685362,0.0000694107,0.13973051,0.0000694107,0.3311263,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107,0.0000694107},
{0.20032601,0.00004954168,0.13826236,0.00004954168,0.17695442,0.00004954168,0.11633957,0.00004954168,0.21264134,0.00004954168,0.15260287,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168,0.00004954168},
{0.000067560664,0.11582369,0.23127992,0.000067560664,0.000067560664,0.09351714,0.17876881,0.000067560664,0.000067560664,0.15269864,0.22399326,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664,0.000067560664},
{0.00066328014,0.00066328014,0.36404374,0.00066328014,0.00066328014,0.00066328014,0.2767496,0.00066328014,0.00066328014,0.00066328014,0.31874657,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014,0.00066328014},
{0.00005219878,0.00005219878,0.14509605,0.15722145,0.00005219878,0.00005219878,0.113716945,0.16565345,0.00005219878,0.00005219878,0.14398079,0.27130377,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878,0.00005219878},
{0.14789075,0.000041242547,0.000041242547,0.09218011,0.15414453,0.000041242547,0.000041242547,0.105847485,0.32092032,0.000041242547,0.000041242547,0.17662473,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547,0.000041242547},
{0.0000593167,0.09314458,0.0000593167,0.13729936,0.0000593167,0.09594404,0.0000593167,0.14588436,0.0000593167,0.26814476,0.0000593167,0.25614253,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167,0.0000593167},
{0.000040569717,0.000040569717,0.15474181,0.12115404,0.000040569717,0.000040569717,0.14070171,0.1254,0.000040569717,0.000040569717,0.2535182,0.2021312,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717,0.000040569717},
{0.00041754078,0.00041754078,0.00041754078,0.25045317,0.00041754078,0.00041754078,0.00041754078,0.26834634,0.00041754078,0.00041754078,0.00041754078,0.4557305,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078,0.00041754078}

	},


    {// stickPmf

    {0.000101342164,0.23210075,0.1448056,0.1309934,0.000101342164,0.091484785,0.069466345,0.09003387,0.000101342164,0.090641916,0.058682058,0.08621746,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164,0.000101342164},
{0.0002446505,0.0002446505,0.24459083,0.26347667,0.0002446505,0.0002446505,0.10226988,0.1418794,0.0002446505,0.0002446505,0.0878713,0.1457222,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505,0.0002446505},
{0.00022331519,0.22609302,0.00022331519,0.3049723,0.00022331519,0.12088433,0.00022331519,0.1001378,0.00022331519,0.13480613,0.00022331519,0.10015414,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519,0.00022331519},
{0.00015667213,0.32113966,0.220816,0.00015667213,0.00015667213,0.13909428,0.08648302,0.00015667213,0.00015667213,0.14679797,0.076582104,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213,0.00015667213},
{0.00025784704,0.00025784704,0.2944173,0.23377293,0.00025784704,0.00025784704,0.11146539,0.1257413,0.00025784704,0.00025784704,0.09245389,0.12719406,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704,0.00025784704},
{0.16737722,0.00014269158,0.15576701,0.13336442,0.1030094,0.00014269158,0.08214162,0.072480366,0.11388528,0.00014269158,0.078703105,0.08542354,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158,0.00014269158},
{0.48987594,0.00014613161,0.00014613161,0.19125064,0.08665961,0.00014613161,0.00014613161,0.06969052,0.08235051,0.00014613161,0.00014613161,0.07169716,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161,0.00014613161},
{0.38660464,0.00021218127,0.2300045,0.00021218127,0.090554826,0.00021218127,0.095471226,0.00021218127,0.103244305,0.00021218127,0.08181399,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127,0.00021218127},
{0.00024024375,0.34372437,0.00024024375,0.17840736,0.00024024375,0.11779562,0.00024024375,0.108812846,0.00024024375,0.12948553,0.00024024375,0.10784015,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375,0.00024024375},
{0.24590501,0.00017202317,0.00017202317,0.33208862,0.112247206,0.00017202317,0.00017202317,0.101464294,0.10599144,0.00017202317,0.00017202317,0.09232609,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317,0.00017202317},
{0.18598366,0.11921695,0.00010288789,0.14730032,0.08417484,0.07907561,0.00010288789,0.08127892,0.086749546,0.11186423,0.00010288789,0.09869709,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789,0.00010288789},
{0.34792632,0.27844614,0.00014653742,0.00014653742,0.09708283,0.079991564,0.00014653742,0.00014653742,0.105896525,0.08215746,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742,0.00014653742},
{0.000333667,0.26445144,0.24113545,0.000333667,0.000333667,0.13884616,0.10018148,0.000333667,0.000333667,0.14495796,0.09107482,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667,0.000333667},
{0.25093722,0.0002789552,0.25111413,0.0002789552,0.14066146,0.0002789552,0.08996645,0.0002789552,0.16742076,0.0002789552,0.08372058,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552,0.0002789552},
{0.28679758,0.23526531,0.00020699753,0.00020699753,0.1155854,0.11367698,0.00020699753,0.00020699753,0.12025042,0.116418436,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753,0.00020699753},
{0.207951,0.16726714,0.14668314,0.000115403236,0.082687825,0.07389747,0.057985906,0.000115403236,0.112715185,0.086256884,0.058208264,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236,0.000115403236}

}};
// match, branch, stick, dark
// [context_num, state_num, feature_num], the last feature is 1!, it is used as bias
static constexpr const double transProbs[CONTEXT_NUMBER][4][4] = {
 {{1.8385282811148296, 0.5323420327296079, -0.08931863771520379, -0.5612239089992404},
{-0.14918568016629322, -0.5551443819672534, 0.08721116411355125, -0.34787650105918483},
{-0.6921599612900088, -0.4618347345575135, 0.10574189506340947, 0.913844361705318},
{-0.9971826396577654, 0.48463708379536535, -0.10363442146180424, -0.004743951646939007}} ,//A:A   ['Match', 'Branch', 'Stick', 'Dark']

{{4.781656124230685, 0.06047739473492592, -0.026245911457544423, -2.3459601971483677},
{0.01432418265522528, 0.20419107030214453, -0.016766503291717857, -0.9681182258606587},
{-2.596707463573438, -0.517890610957252, 0.10396203428248564, 2.2184963356741565},
{-2.1992728433083055, 0.2532221459205954, -0.060949619531513496, 1.0955820873345572}} ,//A:C   ['Match', 'Branch', 'Stick', 'Dark']

{{0.7650649056211348, 0.8529437731134288, -0.1439851823792779, -0.7203075852750017},
{1.1929317223460947, -0.030498543050408843, 0.029740218501422406, -1.5977409782717928},
{1.3994762564108647, -1.247339738688531, 0.1996640556567093, 0.5003373689526589},
{-3.3574728843788857, 0.42489450862479305, -0.0854190917790391, 1.817711194594587}} ,//A:G   ['Match', 'Branch', 'Stick', 'Dark']

{{4.117372179978244, 0.4223829860599765, -0.04634186895502359, -3.1235685914292923},
{-1.925672236560043, -0.03219923678644387, -0.007464984596392611, 2.016873885063642},
{-0.7628101653576138, -0.7749492017042922, 0.09210188255978279, 1.6931003099560424},
{-1.4288897780559238, 0.38476545243258237, -0.0382950290073738, -0.5864056035826204}} ,//A:T   ['Match', 'Branch', 'Stick', 'Dark']

{{3.2244659714994115, 0.6334316118549348, -0.09746124819361654, -2.5083489160658017},
{-0.2251924030628903, -0.024075821246736715, -0.03198355668258591, 0.4112838558549055},
{-3.7299679590389307, -0.9774221173967005, 0.19833430247971562, 3.9036801664015455},
{0.730694390608908, 0.36806632678912726, -0.06888949760062184, -1.8066151061969518}} ,//C:A   ['Match', 'Branch', 'Stick', 'Dark']

{{4.123680775766532, 0.12882797463467702, -0.06583011209562484, -1.1871754399103895},
{-1.1395881716403748, -0.6159459590720554, 0.1510538158834089, -0.06929868860281911},
{-3.5964588648900895, -0.062418998441174135, 0.03393519400395854, 2.8000201081224767},
{0.6123662607728175, 0.5495369828799295, -0.1191588977915508, -1.5435459796106707}} ,//C:C   ['Match', 'Branch', 'Stick', 'Dark']

{{0.6791020607597237, 0.8166921229004271, -0.13817017079411226, -0.468148136305012},
{1.8295175017266438, -0.07024914290068716, 0.03862688022903717, -2.2336156702570675},
{0.7098272278821122, -1.345372547076776, 0.2145226388164627, 1.4875669242125389},
{-3.218446790369011, 0.5989295670774457, -0.1149793482513863, 1.2141968823475164}} ,//C:G   ['Match', 'Branch', 'Stick', 'Dark']

{{5.3629339702542875, 0.3523362157375917, -0.04830356323447398, -3.863110408242919},
{-0.4314314816294209, 0.0025383453012732295, -0.006922121853136949, 0.24403620142920143},
{-4.2991545725189555, -0.6415553463315774, 0.10494714614494756, 4.574378724163514},
{-0.6323479161138715, 0.286680785293091, -0.049721461057004444, -0.9553045173376778}} ,//C:T   ['Match', 'Branch', 'Stick', 'Dark']

{{2.8624070257093357, 0.5287254623984817, -0.0831090013688741, -1.9829039661083252},
{-1.5993135546100554, 0.10837309894062536, -0.051681674479533216, 1.3357723156741388},
{-1.1373912068343663, -0.6605306416612254, 0.14509757123733058, 0.7643204086609725},
{-0.1257022642670082, 0.02343208032191181, -0.010306895389093806, -0.11718875822585935}} ,//G:A   ['Match', 'Branch', 'Stick', 'Dark']

{{6.385784924103498, -0.039400309806979776, -0.027643115115060946, -3.26819000446196},
{0.5787628836006183, 0.1937506979016329, -0.021397791529165256, -1.7776671211356385},
{-6.107528263986641, -0.20569560526725403, 0.07800602193435817, 4.579548682935011},
{-0.8570195437143466, 0.05134521717223983, -0.02896511529034458, 0.4663084426661663}} ,//G:C   ['Match', 'Branch', 'Stick', 'Dark']

{{1.8261351581516836, 0.7491832759265048, -0.13046474142177847, -0.9982773887537789},
{0.7859242151128301, -1.247574713021945, 0.2450698152187221, -0.23094960772120843},
{0.04183332067479778, -1.1323301260886065, 0.1387633757837706, 2.7484353210400685},
{-2.653892693938691, 1.63072156318553, -0.2533684495809841, -1.5192083245668395}} ,//G:G   ['Match', 'Branch', 'Stick', 'Dark']

{{3.9754685956594966, 0.2944571154804082, -0.032922171098236815, -2.556041176291486},
{-1.2242645127484844, 0.15401186152127572, -0.037864376293260865, 0.7301132970089136},
{-1.0911587486145762, -0.5998020565107478, 0.07966228892206939, 1.6623356774181661},
{-1.6600453342940358, 0.15133307951100572, -0.008875741530596823, 0.16359220186556914}} ,//G:T   ['Match', 'Branch', 'Stick', 'Dark']

{{2.7680298702413957, 0.48295944698544174, -0.0762710033326127, -1.7361408342826672},
{-1.8328562240757904, 0.15062227740235903, -0.05785586354065942, 1.8667133297684158},
{-0.6219037174424441, -0.6091497378590028, 0.13912657180208068, 0.023554276009378032},
{-0.3132699287216028, -0.024431986528725597, -0.004999704928138804, -0.15412677149528084}} ,//T:A   ['Match', 'Branch', 'Stick', 'Dark']

{{4.909186195482061, 0.16503380610110674, -0.05034077292800384, -2.52090966561117},
{-1.0241696884283686, 0.4544507029655504, -0.04651198276382292, -0.664084699935525},
{-2.2046351746988777, -0.5809315107944578, 0.09954713702942972, 2.1423548009758666},
{-1.6803813323446706, -0.038552998272530885, -0.002694381338188627, 1.0426395645757724}} ,//T:C   ['Match', 'Branch', 'Stick', 'Dark']

{{1.0146019139827207, 0.9637746216124647, -0.13111846181162165, -1.3577399496985543},
{1.7168446665800086, 0.204995023150165, 0.004057056824808538, -2.426078475294273},
{0.4022286232773607, -1.8472566644372947, 0.19018447493153226, 3.6914362772849385},
{-3.133675203837432, 0.6784870196740721, -0.06312306994435181, 0.09238214770509467}} ,//T:G   ['Match', 'Branch', 'Stick', 'Dark']

{{5.4716338026088795, 0.6710165847362587, -0.08909236130848969, -4.366205483321673},
{-2.41760545139787, -0.6458409060732321, 0.06969824893600775, 2.588087965318408},
{-4.372116575113534, -0.6048479158031825, 0.07697707941433019, 5.559588083969406},
{1.3180882238916078, 0.5796722371338905, -0.05758296704174748, -3.781470565958644}} //T:T   ['Match', 'Branch', 'Stick', 'Dark']

};

inline double CalculateExpectedLLForEmission(const size_t move, const uint8_t row,
                                             const size_t moment)
{
    double expectedLL = 0;
    for (size_t i = 0; i < OUTCOME_NUMBER; i++) {
        double curProb = emissionPmf[move][row][i];
        double lgCurProb = std::log(curProb);
        if (!std::isfinite(lgCurProb)) continue;
        if (moment == static_cast<uint8_t>(MomentType::FIRST))
            expectedLL += curProb * lgCurProb;
        else if (moment == static_cast<uint8_t>(MomentType::SECOND))
            expectedLL += curProb * (lgCurProb * lgCurProb);
    }
    return expectedLL;
}

Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model::Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model(const NucleotideLevelFeats& feats){
    for (size_t ctx = 0; ctx < CONTEXT_NUMBER; ++ctx) {
        const uint8_t bp = ctx & 3;  // (equivalent to % 4)

        const double cr = feats.crs[bp];
        const double dw_mean = feats.dw_means[bp];
        const double dw_var = feats.dw_vars[bp];

        Eigen::Matrix<double, 4, 1> features = {cr, std::log(dw_mean + 1.0), std::log(dw_var + 1.0), 1.0};
        // Eigen::MatrixXd weights(transProbs[ctx], 4, 4);
        const int state_num = 4;
        const int features_num = 4;
        constexpr int elements_num = state_num * features_num;
        double ori_weights[elements_num];
        for (int row=0; row < state_num; row++) {
            for (int col=0; col < features_num; col++) {
                int ele_idx = row * state_num + col;
                ori_weights[ele_idx] = transProbs[ctx][row][col];
            }
        }
        Eigen::Matrix<double, 4, 4> weights = Eigen::Map<Eigen::Matrix<double, 4, 4>>(ori_weights, 4, 4);

        Eigen::Matrix<double, 4, 1> logits = weights.transpose() * features;
        Eigen::Matrix<double, 4, 1> exp_values = logits.array().exp();
        auto probs = exp_values / exp_values.sum();

        for (size_t j = 0; j < 4; ++j)
            ctxTrans_[ctx][j] = probs(j, 0);

        // cached expectations
        for (size_t move = 0; move < 3; ++move)
            for (size_t moment = 0; moment < 2; ++moment)
                cachedEmissionExpectations_[ctx][move][moment] =
                    CalculateExpectedLLForEmission(move, ctx, moment);
    }
}

std::unique_ptr<AbstractRecursor> Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model::CreateRecursor(const MappedRead& mr,
                                                                 double scoreDiff) const
{
    const double counterWeight = CounterWeight(
        [this](size_t ctx, MoveType m) { return ctxTrans_[ctx][static_cast<uint8_t>(m)]; },
        [](size_t ctx, MoveType m) {
            double r = 0.0;
            for (size_t o = 0; o < OUTCOME_NUMBER; ++o) {
                const double p = emissionPmf[static_cast<uint8_t>(m)][ctx][o];
                if (p > 0.0) r += p * std::log(p);
            }
            return r;
        },
        CONTEXT_NUMBER);

    return std::make_unique<Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor>(mr, scoreDiff, counterWeight);
}

std::vector<TemplatePosition> Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model::Populate(const std::string& tpl) const
{
    auto rowFetcher = [this](const NCBI2na prev, const NCBI2na curr) -> const double(&)[4]
    {
        const auto row = EncodeContext16(prev, curr);
        const double(&params)[4] = ctxTrans_[row];
        return params;
    };
    return AbstractPopulater(tpl, rowFetcher);
}

double Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model::ExpectedLLForEmission(const MoveType move, const AlleleRep& prev,
                                             const AlleleRep& curr, const MomentType moment) const
{
    auto cachedEmissionVisitor = [this](const MoveType move, const NCBI2na prev, const NCBI2na curr,
                                        const MomentType moment) -> double {
        const auto row = EncodeContext16(prev, curr);
        return cachedEmissionExpectations_[row][static_cast<uint8_t>(move)]
                                          [static_cast<uint8_t>(moment)];
    };
    return AbstractExpectedLLForEmission(move, prev, curr, moment, cachedEmissionVisitor);
}

Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor::Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor(const MappedRead& mr, double scoreDiff, double counterWeight)
    : Recursor<Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor>(mr, scoreDiff)
    , counterWeight_{counterWeight}
    , nLgCounterWeight_{-std::log(counterWeight_)}
{
}

std::vector<uint8_t> Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor::EncodeRead(const MappedRead& read)
{
    std::vector<uint8_t> result;
    result.reserve(read.Length());
    std::vector<uint8_t> pw_boundaries = {18, 46};
    std::vector<uint8_t> cr_boundaries = {255};
    for (size_t i = 0; i < read.Length(); ++i) {
        result.emplace_back(EncodeBaseV3(read.Seq[i], read.PulseWidth[i], pw_boundaries, read.CR[i], cr_boundaries));
    }

    return result;
}

double Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor::EmissionPr(const MoveType move, const uint8_t emission,
                                     const AlleleRep& prev, const AlleleRep& curr) const
{
    return AbstractEmissionPrV2(emissionPmf, move, emission, prev, curr) * counterWeight_;
}

double Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Recursor::UndoCounterWeights(const size_t nEmissions) const
{
    return nLgCounterWeight_ * nEmissions;
}

inline std::pair<Data::SNR, std::vector<TemplatePosition>> Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_InitialiseModel(
    std::default_random_engine* const rng, const std::string& tpl)
{
    Data::SNR snrs{0, 0, 0, 0};
    for (uint8_t i = 0; i < 4; ++i) {
        snrs[i] = std::uniform_real_distribution<double>{snrRanges[0][i], snrRanges[1][i]}(*rng);
    }

    Data::NucleotideLevelFeats feats;
    const Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model model{feats};
    std::vector<TemplatePosition> transModel = model.Populate(tpl);

    return {snrs, transModel};
}

BaseData Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_GenerateReadData(std::default_random_engine* const rng, const MoveType state,
                                   const AlleleRep& prev, const AlleleRep& curr)
{
    // distribution is arbitrary at the moment, as
    // IPD is not a covariate of the consensus HMM
    std::uniform_int_distribution<uint8_t> ipdDistrib(1, 5);

    std::array<double, OUTCOME_NUMBER> emissionDist;
    for (size_t i = 0; i < OUTCOME_NUMBER; ++i) {
        emissionDist[i] = AbstractEmissionPrV2(emissionPmf, state, i, prev, curr);
    }

    std::discrete_distribution<uint8_t> outcomeDistrib(emissionDist.cbegin(), emissionDist.cend());

    const uint8_t event = outcomeDistrib(*rng);
    const std::pair<char, uint8_t> outcome = DecodeEmission(event);

    return {outcome.first, outcome.second, ipdDistrib(*rng)};
}

std::pair<Data::Read, std::vector<MoveType>> Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_Model::SimulateRead(
    std::default_random_engine* const rng, const std::string& tpl,
    const std::string& readname) const
{
    return SimulateReadImpl(rng, tpl, readname, Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_InitialiseModel,
                            Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1_GenerateReadData);
}

}  // namespace anonymous
}  // namespace S_P2C2v5

REGISTER_MODEL_IMPL(Kit__500_Chem__1_BC__1_PW3_v2_Trans_v1)

}  // namespace Consensus
}  // namespace PacBio
